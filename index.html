<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üõí Sistema de Vendas Completo</title>
  <style>
    :root { --primary: #3498db; --success: #2ecc71; --danger: #e74c3c; --warning: #f39c12; --dark: #2c3e50; --light: #ecf0f1; --backup: #9b59b6; --zreport: #34495e; --whatsapp: #25D366; --barcode: #9b59b6; }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: #f5f7fa; color: #333; height: 100vh; overflow: hidden; }
    .header { background: var(--dark); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: relative; z-index: 100; }
    .logo { font-size: 24px; font-weight: bold; display: flex; align-items: center; gap: 10px; }
    .logo i { font-size: 28px; }
    .container { display: flex; height: calc(100vh - 70px); }
    .sidebar { width: 350px; background: white; border-right: 1px solid #ddd; padding: 20px; overflow-y: auto; }
    .search-box { margin-bottom: 20px; position: relative; }
    .search-box input { width: 100%; padding: 14px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
    .search-box input:focus { border-color: var(--primary); outline: none; }
    .payment-box { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid var(--warning); }
    .payment-box .label { font-weight: bold; color: #7f8c8d; margin-bottom: 10px; display: block; }
    .payment-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
    .payment-option { padding: 10px; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; text-align: center; transition: all 0.2s; }
    .payment-option:hover { border-color: var(--primary); background: #f8f9fa; }
    .payment-option.selected { border-color: var(--primary); background: #e3f2fd; font-weight: bold; }
    .payment-option i { font-size: 24px; margin-bottom: 5px; display: block; }
    .payment-option.pix i { color: #009688; }
    .payment-option.credit i { color: #3498db; }
    .payment-option.debit i { color: #e74c3c; }
    .payment-option.money i { color: #2ecc71; }
    .payment-input { display: none; }
    .payment-input.active { display: block; margin-top: 10px; }
    .client-box { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .client-box .label { font-weight: bold; color: #7f8c8d; margin-bottom: 8px; display: block; }
    .client-selected { background: #e3f2fd; padding: 12px; border-radius: 6px; margin-top: 10px; }
    .client-selected .name { font-weight: bold; color: #2980b9; }
    .client-selected .doc { font-size: 14px; color: #7f8c8d; }
    .btn-client { background: var(--success); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; width: 100%; margin-top: 10px; }
    .btn-client:hover { background: #27ae60; }
    .products-list { max-height: 250px; overflow-y: auto; }
    .product-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; }
    .product-item:hover { background: #f8f9fa; }
    .product-item .name { font-weight: 500; }
    .product-item .price { color: var(--primary); font-weight: bold; margin-top: 4px; }
    .cart { flex: 1; display: flex; flex-direction: column; background: #f8f9fa; padding: 20px; }
    .cart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .cart-title { font-size: 24px; font-weight: bold; color: var(--dark); }
    .cart-items { background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); flex: 1; overflow-y: auto; }
    .cart-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
    .cart-item:last-child { border-bottom: none; }
    .cart-item .desc { flex: 2; }
    .cart-item .qty { flex: 1; text-align: center; color: #7f8c8d; }
    .cart-item .price { flex: 1; text-align: right; font-weight: bold; }
    .cart-total { background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding: 20px; margin-top: 20px; }
    .total-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 18px; }
    .total-row.final { font-size: 24px; font-weight: bold; color: var(--primary); margin-top: 15px; padding-top: 15px; border-top: 2px solid #eee; }
    .total-row.change { color: var(--success); font-weight: bold; }
    .actions { display: flex; gap: 15px; margin-top: 25px; }
    .btn { padding: 15px 25px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: var(--primary); color: white; flex: 1; }
    .btn-primary:hover { background: #2980b9; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-danger:hover { background: #c0392b; }
    .btn-warning { background: var(--warning); color: white; }
    .btn-warning:hover { background: #e67e22; }
    .btn-backup { background: var(--backup); color: white; }
    .btn-backup:hover { background: #8e44ad; }
    .btn-zreport { background: var(--zreport); color: white; }
    .btn-zreport:hover { background: #2c3e50; }
    .btn-whatsapp { background: var(--whatsapp); color: white; }
    .btn-whatsapp:hover { background: #128C7E; }
    .btn-barcode { background: var(--barcode); color: white; }
    .btn-barcode:hover { background: #8e44ad; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); position: relative; }
    .modal h3 { margin-bottom: 20px; color: var(--dark); text-align: center; }
    .form-group { margin-bottom: 15px; text-align: left; }
    .form-group label { display: block; margin-bottom: 8px; color: #7f8c8d; font-weight: 500; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--primary); outline: none; }
    .modal-buttons { display: flex; gap: 15px; margin-top: 20px; }
    .badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; }
    .badge-cpf { background: var(--primary); color: white; }
    .badge-cnpj { background: var(--success); color: white; }
    .badge-backup { background: var(--backup); color: white; }
    .badge-pix { background: #009688; color: white; }
    .badge-credit { background: #3498db; color: white; }
    .badge-debit { background: #e74c3c; color: white; }
    .badge-money { background: #2ecc71; color: white; }
    .empty { padding: 40px; text-align: center; color: #999; }
    .empty-cart { padding: 30px; text-align: center; color: #999; }
    .client-list { max-height: 300px; overflow-y: auto; margin-top: 10px; }
    .client-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
    .client-item:hover { background: #f8f9fa; }
    .client-item .name { font-weight: 500; }
    .client-item .doc { font-size: 12px; color: #7f8c8d; }
    .login-container { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); padding: 40px; width: 100%; max-width: 400px; text-align: center; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
    .login-title { color: var(--dark); margin-bottom: 30px; font-size: 28px; display: flex; justify-content: center; align-items: center; gap: 10px; }
    .login-title i { font-size: 32px; }
    .error { color: var(--danger); background: #fadbd8; padding: 12px; border-radius: 8px; margin-bottom: 20px; display: none; }
    .footer { margin-top: 30px; color: #7f8c8d; font-size: 14px; }
    .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
    .tab { padding: 12px 20px; cursor: pointer; font-weight: 500; }
    .tab.active { border-bottom: 3px solid var(--primary); color: var(--primary); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .status-bar { background: #2c3e50; color: white; padding: 8px 20px; font-size: 14px; text-align: center; position: absolute; bottom: 0; left: 0; right: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center; }
    .status-offline { background: #e74c3c; }
    .backup-info { display: flex; align-items: center; gap: 10px; font-size: 13px; }
    .backup-info i { font-size: 16px; }
    .backup-timer { font-size: 12px; color: #f1c40f; }
    .notification { position: fixed; top: 20px; right: 20px; background: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 9999; display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s ease-out; }
    .notification.success { border-left: 4px solid var(--success); }
    .notification.error { border-left: 4px solid var(--danger); }
    .notification.warning { border-left: 4px solid var(--warning); }
    .notification i { font-size: 20px; }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .backup-list { max-height: 300px; overflow-y: auto; }
    .backup-item { padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .backup-item:last-child { border-bottom: none; }
    .backup-item .info { flex: 1; }
    .backup-item .name { font-weight: 500; font-size: 14px; }
    .backup-item .date { font-size: 12px; color: #7f8c8d; }
    .backup-item .actions { display: flex; gap: 8px; }
    .btn-sm { padding: 6px 10px; font-size: 12px; }
    .cloud-status { display: flex; align-items: center; gap: 5px; font-size: 12px; }
    .cloud-status.online { color: var(--success); }
    .cloud-status.offline { color: var(--danger); }
    .cupom { width: 80mm; margin: 0 auto; padding: 20px; background: white; border: 1px dashed #ddd; font-family: 'Courier New', monospace; font-size: 12px; }
    .cupom h2 { text-align: center; margin-bottom: 10px; font-size: 16px; }
    .cupom .header { text-align: center; margin-bottom: 15px; border-bottom: 2px dashed #000; padding-bottom: 10px; }
    .cupom .header .title { font-weight: bold; font-size: 18px; }
    .cupom .header .cnpj { font-size: 11px; margin-top: 5px; }
    .cupom .header .endereco { font-size: 10px; margin-top: 3px; }
    .cupom .info { margin-bottom: 15px; font-size: 11px; }
    .cupom .info-row { display: flex; justify-content: space-between; margin-bottom: 3px; }
    .cupom .items { margin-bottom: 15px; }
    .cupom .item { display: flex; justify-content: space-between; margin-bottom: 3px; font-size: 11px; }
    .cupom .item .desc { flex: 2; }
    .cupom .item .qty { flex: 0.5; text-align: center; }
    .cupom .item .price { flex: 1; text-align: right; }
    .cupom .total { border-top: 2px solid #000; border-bottom: 2px solid #000; padding: 8px 0; margin-bottom: 15px; font-weight: bold; font-size: 14px; }
    .cupom .payment-info { background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 10px; }
    .cupom .footer { text-align: center; font-size: 10px; color: #666; }
    .cupom .footer p { margin: 3px 0; }
    .zreport { background: white; padding: 30px; margin: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .zreport h2 { text-align: center; color: var(--zreport); margin-bottom: 20px; }
    .zreport .section { margin-bottom: 20px; }
    .zreport .section-title { font-weight: bold; color: var(--dark); margin-bottom: 10px; border-bottom: 2px solid var(--zreport); padding-bottom: 5px; }
    .zreport .row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
    .zreport .row.total { font-weight: bold; font-size: 16px; color: var(--primary); margin-top: 15px; padding-top: 15px; border-top: 2px solid #ddd; }
    .zreport .highlight { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px; }
    .barcode-reader { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px dashed var(--barcode); }
    .barcode-reader .label { font-weight: bold; color: var(--barcode); margin-bottom: 10px; display: block; text-align: center; }
    .barcode-reader input { width: 100%; padding: 12px; border: 2px solid var(--barcode); border-radius: 6px; font-size: 18px; text-align: center; font-weight: bold; }
    .barcode-reader .hint { font-size: 12px; color: #7f8c8d; margin-top: 8px; text-align: center; }
    @media print {
      body { background: white; }
      .header, .sidebar, .actions, .status-bar { display: none !important; }
      .container { height: auto !important; }
      .cart { width: 100% !important; padding: 0 !important; background: white !important; }
      .cupom { width: 100%; border: none; box-shadow: none; }
    }
    @media (max-width: 900px) {
      .container { flex-direction: column; }
      .sidebar { width: 100%; height: auto; max-height: 40%; }
      .actions { flex-direction: column; }
    }
  </style>
</head>
<body>
  <!-- Tela de Login -->
  <div id="screen-login" class="screen" style="height:100vh; background: linear-gradient(135deg, #1a2a6c, #2c3e50); display:flex; align-items:center; justify-content:center;">
    <div class="login-container">
      <div class="login-title">
        <i>üõí</i> Sistema de Vendas Completo
      </div>
      <div id="error-login" class="error"></div>
      
      <div class="form-group">
        <label for="login-user">Usu√°rio</label>
        <input type="text" id="login-user" placeholder="admin ou operador" required autofocus>
      </div>
      
      <div class="form-group">
        <label for="login-pass">Senha</label>
        <input type="password" id="login-pass" placeholder="Senha" required>
      </div>
      
      <button class="btn btn-primary" id="btn-login" style="width:100%">Entrar</button>
      
      <div class="footer" style="margin-top:25px;">
        <p>üîê Admin: admin / senha</p>
        <p>üë§ Operador: operador / operador123</p>
        <p style="margin-top:15px; font-size:12px; color:#9b59b6;">
          üíæ Backup autom√°tico ‚Ä¢ üîí Prote√ß√£o por senha ‚Ä¢ üìÑ Cupom fiscal
        </p>
        <p style="margin-top:10px; font-size:12px; color:#25D366;">
          üí¨ WhatsApp auto ‚Ä¢ üì± Leitor de c√≥digo de barras
        </p>
      </div>
    </div>
  </div>

  <!-- Tela Principal (Vendas) -->
  <div id="screen-vendas" class="screen" style="display:none;">
    <div class="header">
      <div class="logo">
        <i>üõí</i> Armarinho - <span id="user-name">Operador</span>
      </div>
      <div style="display: flex; gap: 10px;">
        <button class="btn btn-zreport" id="btn-leitura-z" title="Leitura Z" style="padding:8px 15px; font-size:14px;">
          üìä Leitura Z
        </button>
        <button class="btn btn-backup" id="btn-backup" title="Backup e Restaura√ß√£o" style="padding:8px 15px; font-size:14px;">
          üíæ Backup
        </button>
        <button class="btn btn-success" id="btn-clientes-menu" style="padding:8px 15px; font-size:14px; background:#2ecc71;">üë• Clientes</button>
        <button class="btn btn-warning" id="btn-produtos-menu" style="padding:8px 15px; font-size:14px; background:#f39c12;">üì¶ Produtos</button>
        <button class="btn btn-danger" id="btn-logout" style="padding:8px 15px; font-size:14px;">Sair</button>
      </div>
    </div>

    <div class="container">
      <div class="sidebar">
        <!-- Leitor de C√≥digo de Barras -->
        <div class="barcode-reader">
          <span class="label">üì± Leitor de C√≥digo de Barras</span>
          <input type="text" id="barcode-input" placeholder="Aponte o leitor aqui..." autocomplete="off">
          <div class="hint">üí° Dica: O leitor funciona como teclado</div>
        </div>
        
        <div class="client-box">
          <span class="label">üë§ Cliente</span>
          <div id="cliente-selecionado">
            <div style="color: #7f8c8d; font-style: italic;">Nenhum cliente selecionado</div>
          </div>
          <button class="btn-client" id="btn-selecionar-cliente">Selecionar Cliente</button>
        </div>
        
        <div class="search-box">
          <input type="text" id="busca-produto" placeholder="C√≥digo ou nome do produto (F2)" autofocus>
        </div>
        
        <div class="products-list" id="lista-produtos">
          <!-- Produtos carregados do localStorage -->
        </div>
        
        <div class="shortcut-hint" style="background:#e3f2fd; color:#1976d2; padding:10px; border-radius:8px; margin-top:15px; text-align:center; font-size:14px;">
          <strong>Atalhos:</strong> F2 = Buscar ‚Ä¢ F3 = Finalizar ‚Ä¢ F4 = Sangria ‚Ä¢ ESC = Limpar
        </div>
      </div>
      
      <div class="cart">
        <div class="cart-header">
          <div class="cart-title">Carrinho</div>
          <div id="cart-count">0 itens</div>
        </div>
        
        <div class="cart-items" id="itens-carrinho">
          <div class="empty-cart">Carrinho vazio. Adicione produtos para iniciar a venda.</div>
        </div>
        
        <!-- Formas de Pagamento -->
        <div class="payment-box">
          <span class="label">üí≥ Forma de Pagamento</span>
          <div class="payment-options">
            <div class="payment-option selected" data-payment="pix">
              <i>üì±</i>
              <div>Pix</div>
            </div>
            <div class="payment-option" data-payment="credit">
              <i>üí≥</i>
              <div>Cr√©dito</div>
            </div>
            <div class="payment-option" data-payment="debit">
              <i>üí≥</i>
              <div>D√©bito</div>
            </div>
            <div class="payment-option" data-payment="money">
              <i>üíµ</i>
              <div>Dinheiro</div>
            </div>
          </div>
          
          <div class="payment-input" id="payment-money-input">
            <div class="form-group">
              <label for="valor-recebido">Valor Recebido (R$)</label>
              <input type="number" id="valor-recebido" step="0.01" min="0.01" placeholder="Digite o valor recebido">
            </div>
            <div class="total-row change" id="troco-row" style="display:none;">
              <span>Troco:</span>
              <span id="troco-valor">R$ 0,00</span>
            </div>
          </div>
        </div>
        
        <div class="cart-total">
          <div class="total-row">
            <span>Subtotal:</span>
            <span id="subtotal">R$ 0,00</span>
          </div>
          <div class="total-row">
            <span>Forma:</span>
            <span id="forma-pagamento">Pix</span>
          </div>
          <div class="total-row final">
            <span>Total:</span>
            <span id="total">R$ 0,00</span>
          </div>
        </div>
        
        <div class="actions">
          <button class="btn btn-warning" id="btn-sangria">F4 - Sangria</button>
          <button class="btn btn-danger" id="btn-cancelar">Cancelar Venda</button>
          <button class="btn btn-primary" id="btn-finalizar">F3 - Finalizar Venda</button>
        </div>
      </div>
    </div>

    <div class="status-bar" id="status-bar">
      <div class="backup-info">
        <i>üíæ</i> <span id="backup-status">Backup autom√°tico: Ativado</span>
        <span class="backup-timer" id="backup-timer"></span>
      </div>
      <div class="cloud-status online" id="cloud-status">
        <i>‚òÅÔ∏è</i> Sistema Completo
      </div>
    </div>
  </div>

  <!-- Modal Leitura Z -->
  <div class="modal" id="modal-leitura-z">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <h3>üìä Leitura Z - Relat√≥rio do Caixa</h3>
      
      <div class="form-group">
        <label for="data-zreport">Selecione o per√≠odo</label>
        <div style="display: flex; gap: 10px; margin-top: 8px;">
          <input type="date" id="data-inicio-zreport" style="flex: 1;">
          <span style="align-self: center;">at√©</span>
          <input type="date" id="data-fim-zreport" style="flex: 1;">
        </div>
        <button class="btn btn-zreport" id="btn-gerar-zreport" style="margin-top: 15px; width: 100%;">
          üìä Gerar Relat√≥rio
        </button>
      </div>
      
      <div id="zreport-container" style="display: none;">
        <div class="zreport" id="zreport-content">
          <!-- Relat√≥rio ser√° gerado aqui -->
        </div>
        <div class="modal-buttons">
          <button class="btn" id="btn-exportar-zreport" style="flex:1; background:#9b59b6; color:white;">üíæ Exportar PDF</button>
          <button class="btn btn-primary" id="btn-imprimir-zreport" style="flex:1;">üñ®Ô∏è Imprimir</button>
        </div>
      </div>
      
      <div class="modal-buttons">
        <button class="btn" id="btn-fechar-zreport" style="flex:1; background:#95a5a6; color:white;">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Modal Consultar Venda por Cupom -->
  <div class="modal" id="modal-consultar-venda">
    <div class="modal-content">
      <h3>üîç Consultar Venda por Cupom</h3>
      
      <div class="form-group">
        <label for="numero-cupom">N√∫mero do Cupom</label>
        <input type="number" id="numero-cupom" placeholder="Digite o n√∫mero do cupom" min="1">
      </div>
      
      <button class="btn btn-primary" id="btn-buscar-cupom" style="width:100%; margin-bottom:15px;">
        üîç Buscar Venda
      </button>
      
      <div id="resultado-cupom" style="display:none;">
        <div class="cupom" id="cupom-consultado">
          <!-- Cupom ser√° carregado aqui -->
        </div>
      </div>
      
      <div class="modal-buttons">
        <button class="btn" id="btn-fechar-consulta" style="flex:1; background:#95a5a6; color:white;">Fechar</button>
        <button class="btn btn-primary" id="btn-imprimir-consulta" style="flex:1; display:none;">üñ®Ô∏è Imprimir</button>
      </div>
    </div>
  </div>

  <!-- Modal Backup -->
  <div class="modal" id="modal-backup">
    <div class="modal-content">
      <h3>üíæ Sistema de Backup</h3>
      
      <div class="tabs">
        <div class="tab active" data-tab="backup-manual">üì§ Backup Manual</div>
        <div class="tab" data-tab="backup-historico">üìã Hist√≥rico</div>
        <div class="tab" data-tab="backup-restaurar">üì• Restaurar</div>
        <div class="tab" data-tab="backup-config">‚öôÔ∏è Configura√ß√µes</div>
      </div>
      
      <!-- Backup Manual -->
      <div class="tab-content active" id="tab-backup-manual">
        <div style="text-align:center; padding:20px; background:#f8f9fa; border-radius:8px; margin-bottom:20px;">
          <div style="font-size:48px; margin-bottom:15px;">üíæ</div>
          <h4 style="margin-bottom:10px;">Backup Manual</h4>
          <p style="color:#7f8c8d; margin-bottom:20px;">Crie um backup dos seus dados agora mesmo</p>
          <button class="btn btn-backup" id="btn-criar-backup" style="width:100%; padding:15px; font-size:18px;">
            üì§ Gerar Backup Agora
          </button>
          <p style="margin-top:15px; font-size:12px; color:#7f8c8d;">
            ‚è±Ô∏è √öltimo backup: <span id="ultimo-backup">Nunca</span>
          </p>
        </div>
        
        <div style="background:#e8f4fc; padding:15px; border-radius:8px; margin-bottom:15px;">
          <strong style="color:#2980b9;">‚ÑπÔ∏è Informa√ß√µes do Backup:</strong>
          <ul style="margin-top:10px; margin-left:20px; font-size:14px; color:#2c3e50;">
            <li>Clientes cadastrados</li>
            <li>Produtos e estoque</li>
            <li>Vendas realizadas</li>
            <li>Movimenta√ß√µes de caixa</li>
            <li>Configura√ß√µes do sistema</li>
          </ul>
        </div>
      </div>
      
      <!-- Hist√≥rico de Backups -->
      <div class="tab-content" id="tab-backup-historico">
        <div style="margin-bottom:15px;">
          <button class="btn btn-backup" id="btn-limpar-historico" style="width:100%; background:#e74c3c;">
            üóëÔ∏è Limpar Todos os Backups
          </button>
        </div>
        
        <div class="backup-list" id="lista-backups">
          <!-- Backups ser√£o carregados aqui -->
        </div>
        
        <div id="backup-vazio" style="padding:30px; text-align:center; color:#999; display:none;">
          Nenhum backup encontrado
        </div>
      </div>
      
      <!-- Restaurar Backup -->
      <div class="tab-content" id="tab-backup-restaurar">
        <div style="background:#fff3cd; padding:15px; border-radius:8px; margin-bottom:20px; border-left:4px solid #ffc107;">
          <strong style="color:#856404;">‚ö†Ô∏è Aten√ß√£o:</strong>
          <p style="margin-top:8px; font-size:14px; color:#856404;">
            Restaurar um backup substituir√° todos os dados atuais. Certifique-se de fazer um backup antes de restaurar!
          </p>
        </div>
        
        <div class="form-group">
          <label for="arquivo-restore">Selecione um arquivo de backup (.json)</label>
          <input type="file" id="arquivo-restore" accept=".json" style="padding:3px;">
        </div>
        
        <button class="btn btn-danger" id="btn-restaurar-arquivo" style="width:100%; padding:15px; font-size:18px;">
          üîÑ Restaurar Backup
        </button>
        
        <div style="margin-top:20px; padding:15px; background:#f8f9fa; border-radius:8px;">
          <strong>üìù Dica:</strong>
          <p style="margin-top:8px; font-size:14px; color:#7f8c8d;">
            Voc√™ tamb√©m pode restaurar backups do hist√≥rico clicando no bot√£o üîÑ ao lado de cada backup na aba "Hist√≥rico".
          </p>
        </div>
      </div>
      
      <!-- Configura√ß√µes de Backup -->
      <div class="tab-content" id="tab-backup-config">
        <div class="form-group">
          <label>Backup Autom√°tico</label>
          <div style="display:flex; gap:10px; margin-top:10px;">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
              <input type="radio" name="backup-auto" value="diario" checked> Di√°rio (Recomendado)
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
              <input type="radio" name="backup-auto" value="semanal"> Semanal
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
              <input type="radio" name="backup-auto" value="desativado"> Desativado
            </label>
          </div>
        </div>
        
        <div class="form-group">
          <label for="backup-hora">Hor√°rio do Backup Autom√°tico</label>
          <input type="time" id="backup-hora" value="23:00">
          <p style="margin-top:8px; font-size:12px; color:#7f8c8d;">
            O backup ser√° criado automaticamente neste hor√°rio
          </p>
        </div>
        
        <div class="form-group">
          <label>M√°ximo de Backups Locais</label>
          <select id="max-backups" style="margin-top:8px;">
            <option value="5">5 backups</option>
            <option value="10" selected>10 backups (Recomendado)</option>
            <option value="20">20 backups</option>
            <option value="50">50 backups</option>
            <option value="0">Ilimitado</option>
          </select>
        </div>
        
        <div style="background:#d4edda; padding:15px; border-radius:8px; margin-top:20px; border-left:4px solid #28a745;">
          <strong style="color:#155724;">‚úÖ Backup Local Ativado</strong>
          <p style="margin-top:8px; font-size:14px; color:#155724;">
            Seus dados s√£o salvos automaticamente no navegador. Backup autom√°tico di√°rio √†s 23:00.
          </p>
        </div>
        
        <button class="btn btn-primary" id="btn-salvar-config" style="width:100%; margin-top:20px;">
          üíæ Salvar Configura√ß√µes
        </button>
      </div>
      
      <div class="modal-buttons">
        <button class="btn" id="btn-fechar-backup" style="flex:1; background:#95a5a6; color:white">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Modal Selecionar Cliente -->
  <div class="modal" id="modal-selecionar-cliente">
    <div class="modal-content">
      <h3>üë• Selecionar Cliente</h3>
      <input type="text" id="busca-cliente-modal" placeholder="Buscar por nome ou documento...">
      
      <div class="client-list" id="lista-clientes-modal">
        <!-- Clientes carregados aqui -->
      </div>
      
      <div class="modal-buttons">
        <button class="btn" id="btn-remover-cliente" style="flex:1; background:#95a5a6; color:white">Remover Cliente</button>
        <button class="btn" id="btn-fechar-cliente" style="flex:1; background:#7f8c8d; color:white">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Modal Clientes (CRUD) -->
  <div class="modal" id="modal-clientes">
    <div class="modal-content">
      <h3>üë• Cadastro de Clientes</h3>
      
      <div class="tabs">
        <div class="tab active" data-tab="lista">üìã Lista</div>
        <div class="tab" data-tab="novo">‚ûï Novo</div>
      </div>
      
      <div class="tab-content active" id="tab-lista-clientes">
        <input type="text" id="busca-clientes-lista" placeholder="Buscar clientes..." style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;">
        <div id="container-clientes-lista" style="max-height:350px; overflow-y:auto;">
          <!-- Lista de clientes -->
        </div>
      </div>
      
      <div class="tab-content" id="tab-novo-cliente">
        <div class="form-group">
          <label for="cliente-nome">Nome *</label>
          <input type="text" id="cliente-nome" required>
        </div>
        
        <div class="form-group">
          <label for="cliente-tipo">Tipo de Documento *</label>
          <select id="cliente-tipo" onchange="atualizarMascaraDocumento()">
            <option value="cpf">CPF (Pessoa F√≠sica)</option>
            <option value="cnpj">CNPJ (Pessoa Jur√≠dica)</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="cliente-documento">Documento *</label>
          <input type="text" id="cliente-documento" required maxlength="18">
        </div>
        
        <div class="form-group">
          <label for="cliente-telefone">Telefone</label>
          <input type="text" id="cliente-telefone" placeholder="(00) 00000-0000">
        </div>
        
        <div class="form-group">
          <label for="cliente-email">Email</label>
          <input type="email" id="cliente-email" placeholder="exemplo@email.com">
        </div>
        
        <div class="form-group">
          <label for="cliente-endereco">Endere√ßo</label>
          <input type="text" id="cliente-endereco" placeholder="Rua, n√∫mero, bairro, cidade">
        </div>
      </div>
      
      <div class="modal-buttons">
        <button class="btn btn-danger" id="btn-fechar-clientes" style="flex:1; background:#95a5a6; color:white">Fechar</button>
        <button class="btn btn-success" id="btn-salvar-cliente" style="flex:1">üíæ Salvar Cliente</button>
      </div>
    </div>
  </div>

  <!-- Modal Produtos -->
  <div class="modal" id="modal-produtos">
    <div class="modal-content">
      <h3>üì¶ Produtos</h3>
      
      <div class="tabs">
        <div class="tab active" data-tab="lista-prod">üìã Lista</div>
        <div class="tab" data-tab="novo-prod">‚ûï Novo</div>
      </div>
      
      <div class="tab-content active" id="tab-lista-produtos">
        <input type="text" id="busca-produtos-lista" placeholder="Buscar produtos..." style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;">
        <div id="container-produtos-lista" style="max-height:350px; overflow-y:auto;">
          <!-- Lista de produtos -->
        </div>
      </div>
      
      <div class="tab-content" id="tab-novo-produto">
        <div class="form-group">
          <label for="produto-codigo">C√≥digo</label>
          <input type="text" id="produto-codigo" placeholder="Ex: 001">
        </div>
        
        <div class="form-group">
          <label for="produto-codigo-barra">C√≥digo de Barras</label>
          <input type="text" id="produto-codigo-barra" placeholder="C√≥digo EAN-13 (opcional)">
        </div>
        
        <div class="form-group">
          <label for="produto-descricao">Descri√ß√£o *</label>
          <input type="text" id="produto-descricao" required>
        </div>
        
        <div class="form-group">
          <label for="produto-preco">Pre√ßo de Venda *</label>
          <input type="number" id="produto-preco" step="0.01" min="0.01" required>
        </div>
        
        <div class="form-group">
          <label for="produto-estoque">Estoque</label>
          <input type="number" id="produto-estoque" min="0" value="0">
        </div>
      </div>
      
      <div class="modal-buttons">
        <button class="btn btn-danger" id="btn-fechar-produtos" style="flex:1; background:#95a5a6; color:white">Fechar</button>
        <button class="btn btn-primary" id="btn-salvar-produto" style="flex:1">üíæ Salvar Produto</button>
      </div>
    </div>
  </div>

  <!-- Modal Sangria -->
  <div class="modal" id="modal-sangria">
    <div class="modal-content">
      <h3>üí∞ Sangria de Caixa</h3>
      <input type="number" id="valor-sangria" placeholder="Valor da sangria (ex: 50.00)" step="0.01" min="0.01">
      <input type="text" id="especificacao-sangria" placeholder="Especifica√ß√£o (opcional)">
      <input type="password" id="senha-admin-sangria" placeholder="Senha de Administrador (java1814)">
      
      <div class="modal-buttons">
        <button class="btn btn-danger" id="btn-confirmar-sangria" style="flex:1">Confirmar Sangria</button>
        <button class="btn" id="btn-cancelar-sangria" style="flex:1; background:#95a5a6; color:white">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal Cupom Fiscal -->
  <div class="modal" id="modal-cupom">
    <div class="modal-content" style="max-width: 600px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3>üìÑ Cupom Fiscal</h3>
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-whatsapp" id="btn-whatsapp-cupom" style="padding: 8px 12px; font-size: 14px;">üí¨ WhatsApp</button>
          <button class="btn btn-primary" id="btn-imprimir-cupom" style="padding: 8px 12px; font-size: 14px;">üñ®Ô∏è Imprimir</button>
        </div>
      </div>
      
      <div id="cupom-container">
        <!-- Cupom ser√° gerado aqui -->
      </div>
      
      <div class="modal-buttons">
        <button class="btn" id="btn-fechar-cupom" style="flex:1; background:#95a5a6; color:white">Fechar</button>
        <button class="btn btn-success" id="btn-reimprimir-cupom" style="flex:1;">üñ®Ô∏è Reimprimir</button>
      </div>
    </div>
  </div>

  <!-- Modal Senha Administrador -->
  <div class="modal" id="modal-senha-admin">
    <div class="modal-content">
      <h3>üîê Confirma√ß√£o de Administrador</h3>
      <p>Para realizar esta a√ß√£o, insira a senha de administrador:</p>
      <input type="password" id="senha-admin-input" placeholder="Senha de Administrador (java1814)" style="margin-top: 15px;">
      
      <div class="modal-buttons">
        <button class="btn" id="btn-cancelar-senha" style="flex:1; background:#95a5a6; color:white">Cancelar</button>
        <button class="btn btn-danger" id="btn-confirmar-senha" style="flex:1;">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- Notifications -->
  <div id="notification-container" style="position:fixed; top:20px; right:20px; z-index:9999;"></div>

  <script>
    // ========== DADOS INICIAIS (localStorage) ==========
    function inicializarDados() {
      if (!localStorage.getItem('vendas_db')) {
        localStorage.setItem('vendas_db', JSON.stringify({
          usuarios: [
            { id: 1, nome: 'Administrador', login: 'admin', senha: 'java1814', perfil: 'admin', whatsapp: '+5584999999999' },
            { id: 2, nome: 'Operador', login: 'operador', senha: 'operador123', perfil: 'operador' }
          ],
          produtos: [
            { id: 1, codigo: '001', codigo_barra: '7891234567890', descricao: 'Bot√£o de Madeira', preco_venda: 5.0, estoque: 120, ativo: true },
            { id: 2, codigo: '002', codigo_barra: '7891234567891', descricao: 'Linha de Algod√£o', preco_venda: 8.5, estoque: 85, ativo: true },
            { id: 3, codigo: '003', codigo_barra: '7891234567892', descricao: 'Agulha de Costura', preco_venda: 3.2, estoque: 200, ativo: true },
            { id: 4, codigo: '004', codigo_barra: '7891234567893', descricao: 'Fita M√©trica', preco_venda: 12.0, estoque: 50, ativo: true },
            { id: 5, codigo: '005', codigo_barra: '7891234567894', descricao: 'Tesoura Profissional', preco_venda: 25.0, estoque: 30, ativo: true }
          ],
          clientes: [
            { id: 1, nome: 'Maria Silva', tipo: 'cpf', documento: '12345678901', telefone: '84999999999', email: 'maria@email.com' },
            { id: 2, nome: 'Jo√£o Santos', tipo: 'cpf', documento: '98765432109', telefone: '84888888888', email: 'joao@email.com' },
            { id: 3, nome: 'Confec√ß√£o LTDA', tipo: 'cnpj', documento: '12345678000190', telefone: '8433333333', email: 'contato@confeccao.com.br' }
          ],
          vendas: [],
          movimentacoes: [],
          config: { 
            ultimoIdProduto: 5, 
            ultimoIdCliente: 3, 
            ultimoIdVenda: 0,
            nomeEmpresa: 'Armarinho do Z√©',
            cnpjEmpresa: '12.345.678/0001-90',
            enderecoEmpresa: 'Rua das Flores, 123 - Centro',
            telefoneEmpresa: '(84) 3333-4444',
            whatsappAdmin: '+5584999999999' // N√∫mero do admin para receber cupons
          }
        }));
      }
      
      // Inicializar configura√ß√µes de backup
      if (!localStorage.getItem('backup_config')) {
        localStorage.setItem('backup_config', JSON.stringify({
          auto: 'diario',
          hora: '23:00',
          maxBackups: 10,
          ultimoBackup: null,
          backups: []
        }));
      }
    }

    // ========== SISTEMA DE BACKUP ==========
    const BackupSystem = {
      criarBackup: function() {
        const db = buscarDados();
        const backup = {
          tipo: 'backup_vendas',
          versao: '2.0',
           new Date().toISOString(),
          dados: db
        };
        
        this.salvarBackupLocal(backup);
        this.downloadBackup(backup);
        this.mostrarNotificacao('‚úÖ Backup criado com sucesso!', 'success');
      },
      
      salvarBackupLocal: function(backup) {
        const config = JSON.parse(localStorage.getItem('backup_config'));
        
        config.backups.unshift({
          id: Date.now(),
           backup.data,
          tamanho: JSON.stringify(backup).length,
          nome: `backup-${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}-${new Date().toLocaleTimeString('pt-BR').replace(/:/g, '-')}.json`
        });
        
        if (config.maxBackups > 0 && config.backups.length > config.maxBackups) {
          config.backups = config.backups.slice(0, config.maxBackups);
        }
        
        config.ultimoBackup = backup.data;
        localStorage.setItem('backup_config', JSON.stringify(config));
        this.atualizarStatus();
      },
      
      downloadBackup: function(backup) {
        const dataStr = "text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backup, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", backup.nome || `backup-vendas-${new Date().toISOString().slice(0,10)}.json`);
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
      },
      
      restaurarDeArquivo: function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const backup = JSON.parse(e.target.result);
            
            if (backup.tipo !== 'backup_vendas') {
              this.mostrarNotificacao('‚ùå Arquivo inv√°lido! N√£o √© um backup do sistema de vendas.', 'error');
              return;
            }
            
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Restaurar este backup substituir√° todos os dados atuais. Deseja continuar?')) {
              return;
            }
            
            this.criarBackup();
            localStorage.setItem('vendas_db', JSON.stringify(backup.dados));
            this.mostrarNotificacao('‚úÖ Backup restaurado com sucesso! Recarregando...', 'success');
            
            setTimeout(() => {
              location.reload();
            }, 1500);
            
          } catch (err) {
            this.mostrarNotificacao('‚ùå Erro ao ler arquivo de backup!', 'error');
            console.error(err);
          }
        };
        reader.readAsText(file);
      },
      
      restaurarDoHistorico: function(backupId) {
        const config = JSON.parse(localStorage.getItem('backup_config'));
        const backup = config.backups.find(b => b.id === backupId);
        
        if (!backup) {
          this.mostrarNotificacao('‚ùå Backup n√£o encontrado!', 'error');
          return;
        }
        
        if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Restaurar este backup substituir√° todos os dados atuais. Deseja continuar?')) {
          return;
        }
        
        this.criarBackup();
        this.mostrarNotificacao('‚úÖ Backup restaurado! Recarregando...', 'success');
        
        setTimeout(() => {
          location.reload();
        }, 1500);
      },
      
      limparHistorico: function() {
        if (!confirm('‚ö†Ô∏è Deseja realmente limpar todos os backups do hist√≥rico? Esta a√ß√£o n√£o pode ser desfeita.')) {
          return;
        }
        
        const config = JSON.parse(localStorage.getItem('backup_config'));
        config.backups = [];
        localStorage.setItem('backup_config', JSON.stringify(config));
        
        this.mostrarNotificacao('‚úÖ Hist√≥rico de backups limpo!', 'success');
        this.carregarHistoricoBackups();
      },
      
      carregarHistoricoBackups: function() {
        const config = JSON.parse(localStorage.getItem('backup_config'));
        const lista = document.getElementById('lista-backups');
        const vazio = document.getElementById('backup-vazio');
        
        if (config.backups.length === 0) {
          lista.style.display = 'none';
          vazio.style.display = 'block';
          return;
        }
        
        vazio.style.display = 'none';
        lista.style.display = 'block';
        
        let html = '';
        config.backups.forEach(b => {
          const data = new Date(b.data);
          html += `
            <div class="backup-item">
              <div class="info">
                <div class="name">${b.nome}</div>
                <div class="date">
                  ${data.toLocaleDateString('pt-BR')} √†s ${data.toLocaleTimeString('pt-BR')}
                  ‚Ä¢ ${(b.tamanho / 1024).toFixed(2)} KB
                </div>
              </div>
              <div class="actions">
                <button class="btn btn-sm btn-primary" onclick="BackupSystem.restaurarDoHistorico(${b.id})" title="Restaurar">
                  üîÑ
                </button>
              </div>
            </div>
          `;
        });
        
        lista.innerHTML = html;
      },
      
      atualizarStatus: function() {
        const config = JSON.parse(localStorage.getItem('backup_config'));
        
        if (config.ultimoBackup) {
          const data = new Date(config.ultimoBackup);
          document.getElementById('ultimo-backup').textContent = 
            `${data.toLocaleDateString('pt-BR')} √†s ${data.toLocaleTimeString('pt-BR')}`;
          
          document.getElementById('backup-status').textContent = 
            `‚úÖ Backup: ${data.toLocaleDateString('pt-BR')}`;
        }
      },
      
      verificarBackupAutomatico: function() {
        const config = JSON.parse(localStorage.getItem('backup_config'));
        
        if (config.auto === 'desativado') return;
        
        const agora = new Date();
        const horaAtual = `${agora.getHours().toString().padStart(2, '0')}:${agora.getMinutes().toString().padStart(2, '0')}`;
        
        let ultimoBackupDate = null;
        if (config.ultimoBackup) {
          ultimoBackupDate = new Date(config.ultimoBackup);
        }
        
        const fezBackupHoje = ultimoBackupDate && 
          ultimoBackupDate.getDate() === agora.getDate() &&
          ultimoBackupDate.getMonth() === agora.getMonth() &&
          ultimoBackupDate.getFullYear() === agora.getFullYear();
        
        if (config.auto === 'diario' && horaAtual >= config.hora && !fezBackupHoje) {
          console.log('‚è∞ Criando backup autom√°tico di√°rio...');
          this.criarBackup();
          return;
        }
        
        if (config.auto === 'semanal' && agora.getDay() === 1 && horaAtual >= config.hora && !fezBackupHoje) {
          console.log('‚è∞ Criando backup autom√°tico semanal...');
          this.criarBackup();
        }
      },
      
      atualizarTimer: function() {
        const config = JSON.parse(localStorage.getItem('backup_config'));
        
        if (config.auto === 'desativado') {
          document.getElementById('backup-timer').textContent = '‚ùå Desativado';
          return;
        }
        
        const agora = new Date();
        const [horaConfig, minConfig] = config.hora.split(':');
        const proximoBackup = new Date();
        proximoBackup.setHours(parseInt(horaConfig), parseInt(minConfig), 0, 0);
        
        if (proximoBackup <= agora) {
          proximoBackup.setDate(proximoBackup.getDate() + (config.auto === 'semanal' ? 7 : 1));
        }
        
        const diff = proximoBackup - agora;
        const horas = Math.floor(diff / (1000 * 60 * 60));
        const minutos = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        
        document.getElementById('backup-timer').textContent = 
          `‚è∞ Pr√≥ximo: ${horas}h ${minutos}m`;
      },
      
      mostrarNotificacao: function(mensagem, tipo = 'success') {
        const container = document.getElementById('notification-container');
        const notificacao = document.createElement('div');
        notificacao.className = `notification ${tipo}`;
        notificacao.innerHTML = `
          <i>${tipo === 'success' ? '‚úÖ' : tipo === 'error' ? '‚ùå' : '‚ö†Ô∏è'}</i>
          <span>${mensagem}</span>
        `;
        
        container.appendChild(notificacao);
        
        setTimeout(() => {
          notificacao.style.opacity = '0';
          notificacao.style.transform = 'translateX(400px)';
          setTimeout(() => {
            notificacao.remove();
          }, 300);
        }, 3000);
      },
      
      salvarConfiguracoes: function() {
        const config = JSON.parse(localStorage.getItem('backup_config'));
        config.auto = document.querySelector('input[name="backup-auto"]:checked').value;
        config.hora = document.getElementById('backup-hora').value;
        config.maxBackups = parseInt(document.getElementById('max-backups').value);
        
        localStorage.setItem('backup_config', JSON.stringify(config));
        
        this.mostrarNotificacao('‚úÖ Configura√ß√µes de backup salvas!', 'success');
        this.atualizarTimer();
      }
    };

    // ========== LEITURA Z ==========
    const LeituraZ = {
      gerarRelatorio: function(dataInicio, dataFim) {
        const db = buscarDados();
        
        const vendasPeriodo = db.vendas.filter(v => {
          const dataVenda = new Date(v.data);
          const inicio = new Date(dataInicio);
          const fim = new Date(dataFim);
          fim.setHours(23, 59, 59, 999);
          return dataVenda >= inicio && dataVenda <= fim;
        });
        
        const sangriasPeriodo = db.movimentacoes.filter(m => {
          const dataMov = new Date(m.data);
          const inicio = new Date(dataInicio);
          const fim = new Date(dataFim);
          fim.setHours(23, 59, 59, 999);
          return m.tipo === 'sangria' && dataMov >= inicio && dataMov <= fim;
        });
        
        // Estat√≠sticas por forma de pagamento
        const formasPagamento = {
          pix: { count: 0, total: 0 },
          credit: { count: 0, total: 0 },
          debit: { count: 0, total: 0 },
          money: { count: 0, total: 0 }
        };
        
        vendasPeriodo.forEach(v => {
          const forma = v.forma_pagamento || 'pix';
          formasPagamento[forma].count++;
          formasPagamento[forma].total += v.total;
        });
        
        const totalVendas = vendasPeriodo.reduce((sum, v) => sum + v.total, 0);
        const totalSangrias = sangriasPeriodo.reduce((sum, s) => sum + s.valor, 0);
        const totalLiquido = totalVendas - totalSangrias;
        
        const produtosVendidos = {};
        vendasPeriodo.forEach(v => {
          v.itens.forEach(item => {
            if (!produtosVendidos[item.descricao]) {
              produtosVendidos[item.descricao] = { quantidade: 0, total: 0 };
            }
            produtosVendidos[item.descricao].quantidade += item.quantidade;
            produtosVendidos[item.descricao].total += item.quantidade * item.preco;
          });
        });
        
        const produtosOrdenados = Object.entries(produtosVendidos)
          .sort((a, b) => b[1].quantidade - a[1].quantidade)
          .slice(0, 10);
        
        const inicioFormatada = new Date(dataInicio).toLocaleDateString('pt-BR');
        const fimFormatada = new Date(dataFim).toLocaleDateString('pt-BR');
        
        let html = `
          <h2>üìä LEITURA Z</h2>
          <div class="section">
            <div class="section-title">üìÖ Per√≠odo</div>
            <div class="row">
              <span>In√≠cio:</span>
              <span>${inicioFormatada}</span>
            </div>
            <div class="row">
              <span>Fim:</span>
              <span>${fimFormatada}</span>
            </div>
          </div>
          
          <div class="section">
            <div class="section-title">üí∞ Vendas</div>
            <div class="row">
              <span>Total de Vendas:</span>
              <span>${vendasPeriodo.length}</span>
            </div>
            <div class="row">
              <span>Valor Total:</span>
              <span>R$ ${totalVendas.toFixed(2).replace('.', ',')}</span>
            </div>
          </div>
          
          <div class="section">
            <div class="section-title">üí≥ Formas de Pagamento</div>
            <div class="row">
              <span>Pix (${formasPagamento.pix.count} vendas):</span>
              <span>R$ ${formasPagamento.pix.total.toFixed(2).replace('.', ',')}</span>
            </div>
            <div class="row">
              <span>Cart√£o Cr√©dito (${formasPagamento.credit.count} vendas):</span>
              <span>R$ ${formasPagamento.credit.total.toFixed(2).replace('.', ',')}</span>
            </div>
            <div class="row">
              <span>Cart√£o D√©bito (${formasPagamento.debit.count} vendas):</span>
              <span>R$ ${formasPagamento.debit.total.toFixed(2).replace('.', ',')}</span>
            </div>
            <div class="row">
              <span>Dinheiro (${formasPagamento.money.count} vendas):</span>
              <span>R$ ${formasPagamento.money.total.toFixed(2).replace('.', ',')}</span>
            </div>
          </div>
          
          <div class="section">
            <div class="section-title">üí∏ Sangrias</div>
            <div class="row">
              <span>Total de Sangrias:</span>
              <span>${sangriasPeriodo.length}</span>
            </div>
            <div class="row">
              <span>Valor Total:</span>
              <span>R$ ${totalSangrias.toFixed(2).replace('.', ',')}</span>
            </div>
          </div>
          
          <div class="section">
            <div class="section-title">üìà Resultado</div>
            <div class="row total">
              <span>üí∞ Total L√≠quido:</span>
              <span>R$ ${totalLiquido.toFixed(2).replace('.', ',')}</span>
            </div>
          </div>
          
          <div class="section">
            <div class="section-title">üèÜ Produtos Mais Vendidos (Top 10)</div>
        `;
        
        produtosOrdenados.forEach(([produto, dados]) => {
          html += `
            <div class="row">
              <span>${produto} (${dados.quantidade}x):</span>
              <span>R$ ${dados.total.toFixed(2).replace('.', ',')}</span>
            </div>
          `;
        });
        
        html += `
          </div>
          
          <div class="section">
            <div class="section-title">üîç Consultar Cupom</div>
            <div class="row" style="text-align: center;">
              <button class="btn btn-primary" onclick="document.getElementById('modal-leitura-z').style.display='none'; document.getElementById('modal-consultar-venda').style.display='flex';" style="width: 100%; padding: 10px;">
                üîç Consultar Cupom por N√∫mero
              </button>
            </div>
          </div>
          
          <div class="section">
            <div class="section-title">üìÖ Data da Leitura</div>
            <div class="row">
              <span>Emitido em:</span>
              <span>${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}</span>
            </div>
          </div>
        `;
        
        document.getElementById('zreport-content').innerHTML = html;
        document.getElementById('zreport-container').style.display = 'block';
        
        BackupSystem.mostrarNotificacao('‚úÖ Leitura Z gerada com sucesso!', 'success');
      },
      
      imprimir: function() {
        window.print();
      },
      
      exportarPDF: function() {
        BackupSystem.mostrarNotificacao('‚ÑπÔ∏è Use Imprimir + Salvar como PDF.', 'warning');
      }
    };

    // ========== CUPOM FISCAL ==========
    const CupomFiscal = {
      gerar: function(venda) {
        const db = buscarDados();
        const config = db.config;
        const cliente = venda.cliente_id ? db.clientes.find(c => c.id === venda.cliente_id) : null;
        const usuario = db.usuarios.find(u => u.id === venda.usuario_id);
        const data = new Date(venda.data);
        
        // Mapear forma de pagamento
        const formas = {
          pix: 'Pix',
          credit: 'Cart√£o de Cr√©dito',
          debit: 'Cart√£o de D√©bito',
          money: 'Dinheiro'
        };
        
        let html = `
          <div class="cupom">
            <div class="header">
              <div class="title">${config.nomeEmpresa || 'ARMAZ√âM / ARMARINHO'}</div>
              <div class="cnpj">${config.cnpjEmpresa || 'CNPJ: 00.000.000/0001-00'}</div>
              <div class="endereco">${config.enderecoEmpresa || 'Endere√ßo n√£o configurado'}</div>
              <div class="endereco">üìû ${config.telefoneEmpresa || '(00) 0000-0000'}</div>
            </div>
            
            <div class="info">
              <div class="info-row">
                <span>Cupom:</span>
                <span>${venda.id.toString().padStart(6, '0')}</span>
              </div>
              <div class="info-row">
                <span>Data:</span>
                <span>${data.toLocaleDateString('pt-BR')} ${data.toLocaleTimeString('pt-BR')}</span>
              </div>
              <div class="info-row">
                <span>Operador:</span>
                <span>${usuario.nome}</span>
              </div>
              <div class="info-row">
                <span>Forma Pgto:</span>
                <span>${formas[venda.forma_pagamento] || 'Pix'}</span>
              </div>
              ${venda.valor_recebido ? `
              <div class="info-row">
                <span>Valor Recebido:</span>
                <span>R$ ${venda.valor_recebido.toFixed(2).replace('.', ',')}</span>
              </div>
              <div class="info-row">
                <span>Troco:</span>
                <span>R$ ${venda.troco.toFixed(2).replace('.', ',')}</span>
              </div>
              ` : ''}
              ${cliente ? `
              <div class="info-row">
                <span>Cliente:</span>
                <span>${cliente.nome}</span>
              </div>
              <div class="info-row">
                <span>Documento:</span>
                <span>${formatarDocumento(cliente.documento, cliente.tipo)}</span>
              </div>
              ` : ''}
            </div>
            
            <div class="items">
              <div class="item" style="font-weight: bold; border-bottom: 1px dashed #000; padding-bottom: 5px;">
                <span class="desc">Produto</span>
                <span class="qty">Qtd</span>
                <span class="price">Valor</span>
              </div>
        `;
        
        venda.itens.forEach(item => {
          html += `
            <div class="item">
              <span class="desc">${item.descricao}</span>
              <span class="qty">${item.quantidade}</span>
              <span class="price">R$ ${(item.quantidade * item.preco).toFixed(2).replace('.', ',')}</span>
            </div>
          `;
        });
        
        html += `
            </div>
            
            <div class="total">
              <div class="info-row">
                <span>TOTAL:</span>
                <span>R$ ${venda.total.toFixed(2).replace('.', ',')}</span>
              </div>
            </div>
            
            <div class="footer">
              <p>Obrigado e volte sempre!</p>
              <p>${config.nomeEmpresa}</p>
              <p>${new Date().toLocaleDateString('pt-BR')} ${new Date().toLocaleTimeString('pt-BR')}</p>
            </div>
          </div>
        `;
        
        document.getElementById('cupom-container').innerHTML = html;
        document.getElementById('modal-cupom').style.display = 'flex';
        
        // Enviar para WhatsApp automaticamente
        this.enviarWhatsApp(venda, html);
      },
      
      imprimir: function() {
        window.print();
      },
      
      reimprimir: function() {
        this.imprimir();
        BackupSystem.mostrarNotificacao('‚úÖ Cupom reimpresso!', 'success');
      },
      
      enviarWhatsApp: function(venda, cupomHTML) {
        const db = buscarDados();
        const config = db.config;
        const whatsappAdmin = config.whatsappAdmin || '+5584999999999';
        
        // Extrair texto do cupom para enviar no WhatsApp
        const textoCupom = `
*CUPOM FISCAL - ${config.nomeEmpresa}*

üî¢ Cupom: ${venda.id.toString().padStart(6, '0')}
üìÖ Data: ${new Date(venda.data).toLocaleDateString('pt-BR')} ${new Date(venda.data).toLocaleTimeString('pt-BR')}
üí∞ Total: R$ ${venda.total.toFixed(2)}

${venda.itens.map(item => `‚Ä¢ ${item.descricao} (${item.quantidade}x) - R$ ${(item.quantidade * item.preco).toFixed(2)}`).join('\n')}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
*Total: R$ ${venda.total.toFixed(2)}*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Obrigado e volte sempre!
        `.trim();
        
        const mensagem = encodeURIComponent(textoCupom);
        const urlWhatsApp = `https://wa.me/${whatsappAdmin}?text=${mensagem}`;
        
        // Abrir WhatsApp em nova aba
        window.open(urlWhatsApp, '_blank');
        
        BackupSystem.mostrarNotificacao('‚úÖ Cupom enviado para WhatsApp!', 'success');
      },
      
      consultarPorNumero: function(numeroCupom) {
        const db = buscarDados();
        const venda = db.vendas.find(v => v.id === parseInt(numeroCupom));
        
        if (!venda) {
          BackupSystem.mostrarNotificacao('‚ùå Cupom n√£o encontrado!', 'error');
          return false;
        }
        
        // Gerar cupom para visualiza√ß√£o
        const config = db.config;
        const cliente = venda.cliente_id ? db.clientes.find(c => c.id === venda.cliente_id) : null;
        const usuario = db.usuarios.find(u => u.id === venda.usuario_id);
        const data = new Date(venda.data);
        
        const formas = {
          pix: 'Pix',
          credit: 'Cart√£o de Cr√©dito',
          debit: 'Cart√£o de D√©bito',
          money: 'Dinheiro'
        };
        
        let html = `
          <div class="cupom">
            <div class="header">
              <div class="title">${config.nomeEmpresa || 'ARMAZ√âM / ARMARINHO'}</div>
              <div class="cnpj">${config.cnpjEmpresa || 'CNPJ: 00.000.000/0001-00'}</div>
              <div class="endereco">${config.enderecoEmpresa || 'Endere√ßo n√£o configurado'}</div>
            </div>
            
            <div class="info">
              <div class="info-row">
                <span>Cupom:</span>
                <span>${venda.id.toString().padStart(6, '0')}</span>
              </div>
              <div class="info-row">
                <span>Data:</span>
                <span>${data.toLocaleDateString('pt-BR')} ${data.toLocaleTimeString('pt-BR')}</span>
              </div>
              <div class="info-row">
                <span>Operador:</span>
                <span>${usuario.nome}</span>
              </div>
              <div class="info-row">
                <span>Forma Pgto:</span>
                <span>${formas[venda.forma_pagamento] || 'Pix'}</span>
              </div>
              ${venda.valor_recebido ? `
              <div class="info-row">
                <span>Valor Recebido:</span>
                <span>R$ ${venda.valor_recebido.toFixed(2).replace('.', ',')}</span>
              </div>
              <div class="info-row">
                <span>Troco:</span>
                <span>R$ ${venda.troco.toFixed(2).replace('.', ',')}</span>
              </div>
              ` : ''}
              ${cliente ? `
              <div class="info-row">
                <span>Cliente:</span>
                <span>${cliente.nome}</span>
              </div>
              <div class="info-row">
                <span>Documento:</span>
                <span>${formatarDocumento(cliente.documento, cliente.tipo)}</span>
              </div>
              ` : ''}
            </div>
            
            <div class="items">
              <div class="item" style="font-weight: bold; border-bottom: 1px dashed #000; padding-bottom: 5px;">
                <span class="desc">Produto</span>
                <span class="qty">Qtd</span>
                <span class="price">Valor</span>
              </div>
        `;
        
        venda.itens.forEach(item => {
          html += `
            <div class="item">
              <span class="desc">${item.descricao}</span>
              <span class="qty">${item.quantidade}</span>
              <span class="price">R$ ${(item.quantidade * item.preco).toFixed(2).replace('.', ',')}</span>
            </div>
          `;
        });
        
        html += `
            </div>
            
            <div class="total">
              <div class="info-row">
                <span>TOTAL:</span>
                <span>R$ ${venda.total.toFixed(2).replace('.', ',')}</span>
              </div>
            </div>
            
            <div class="footer">
              <p>Obrigado e volte sempre!</p>
              <p>${config.nomeEmpresa}</p>
            </div>
          </div>
        `;
        
        document.getElementById('cupom-consultado').innerHTML = html;
        document.getElementById('resultado-cupom').style.display = 'block';
        document.getElementById('btn-imprimir-consulta').style.display = 'block';
        
        return true;
      }
    };

    // ========== VERIFICA√á√ÉO DE SENHA ==========
    const VerificacaoSenha = {
      verificar: function(callback) {
        document.getElementById('modal-senha-admin').style.display = 'flex';
        
        const confirmarBtn = document.getElementById('btn-confirmar-senha');
        const cancelarBtn = document.getElementById('btn-cancelar-senha');
        const senhaInput = document.getElementById('senha-admin-input');
        
        function handlerConfirmar() {
          const senha = senhaInput.value;
          
          if (senha === 'java1814') {
            callback(true);
            fecharModal();
          } else {
            BackupSystem.mostrarNotificacao('‚ùå Senha incorreta!', 'error');
            senhaInput.value = '';
            senhaInput.focus();
          }
        }
        
        function handlerCancelar() {
          callback(false);
          fecharModal();
        }
        
        function fecharModal() {
          confirmarBtn.removeEventListener('click', handlerConfirmar);
          cancelarBtn.removeEventListener('click', handlerCancelar);
          senhaInput.removeEventListener('keypress', handleEnter);
          document.getElementById('modal-senha-admin').style.display = 'none';
          senhaInput.value = '';
        }
        
        function handleEnter(e) {
          if (e.key === 'Enter') {
            handlerConfirmar();
          }
        }
        
        confirmarBtn.addEventListener('click', handlerConfirmar);
        cancelarBtn.addEventListener('click', handlerCancelar);
        senhaInput.addEventListener('keypress', handleEnter);
        senhaInput.focus();
      }
    };

    // ========== FUN√á√ïES AUXILIARES ==========
    function formatarMoeda(valor) {
      return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
    }

    function formatarDocumento(doc, tipo) {
      doc = doc.replace(/\D/g, '');
      if (tipo === 'cpf' && doc.length === 11) {
        return doc.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
      } else if (tipo === 'cnpj' && doc.length === 14) {
        return doc.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
      }
      return doc;
    }

    function atualizarMascaraDocumento() {
      const tipo = document.getElementById('cliente-tipo').value;
      const docInput = document.getElementById('cliente-documento');
      docInput.value = '';
      docInput.maxLength = tipo === 'cpf' ? 14 : 18;
    }

    function buscarDados() {
      return JSON.parse(localStorage.getItem('vendas_db'));
    }

    function salvarDados(db) {
      localStorage.setItem('vendas_db', JSON.stringify(db));
    }

    // ========== AUTENTICA√á√ÉO ==========
    document.getElementById('btn-login').addEventListener('click', () => {
      const usuario = document.getElementById('login-user').value.trim();
      const senha = document.getElementById('login-pass').value;
      const errorDiv = document.getElementById('error-login');
      
      const db = buscarDados();
      const user = db.usuarios.find(u => u.login === usuario && u.senha === senha && u.ativo !== false);
      
      if (user) {
        sessionStorage.setItem('user_id', user.id);
        sessionStorage.setItem('user_perfil', user.perfil);
        sessionStorage.setItem('user_nome', user.nome);
        
        document.getElementById('user-name').textContent = user.nome;
        document.getElementById('screen-login').style.display = 'none';
        document.getElementById('screen-vendas').style.display = 'block';
        
        carregarProdutos();
        BackupSystem.atualizarStatus();
        BackupSystem.atualizarTimer();
        errorDiv.style.display = 'none';
      } else {
        errorDiv.textContent = 'Usu√°rio ou senha inv√°lidos!';
        errorDiv.style.display = 'block';
      }
    });

    document.getElementById('btn-logout').addEventListener('click', () => {
      sessionStorage.clear();
      document.getElementById('screen-vendas').style.display = 'none';
      document.getElementById('screen-login').style.display = 'block';
      document.getElementById('login-user').value = '';
      document.getElementById('login-pass').value = '';
    });

    // ========== PRODUTOS ==========
    function carregarProdutos() {
      const db = buscarDados();
      const lista = document.getElementById('lista-produtos');
      lista.innerHTML = '';
      
      db.produtos
        .filter(p => p.ativo !== false)
        .forEach(p => {
          const div = document.createElement('div');
          div.className = 'product-item';
          div.setAttribute('data-id', p.id);
          div.setAttribute('data-preco', p.preco_venda);
          div.setAttribute('data-desc', p.descricao);
          div.setAttribute('data-codigo-barra', p.codigo_barra || '');
          div.innerHTML = `
            <div class="name">${p.descricao}</div>
            <div class="price">${formatarMoeda(p.preco_venda)}</div>
          `;
          div.addEventListener('click', () => adicionarAoCarrinho(p));
          lista.appendChild(div);
        });
    }

    // ========== CARRINHO ==========
    let carrinho = [];
    let clienteSelecionado = null;
    let formaPagamento = 'pix';

    function atualizarCarrinho() {
      const container = document.getElementById('itens-carrinho');
      const countEl = document.getElementById('cart-count');
      const subtotalEl = document.getElementById('subtotal');
      const totalEl = document.getElementById('total');
      const formaEl = document.getElementById('forma-pagamento');
      
      if (carrinho.length === 0) {
        container.innerHTML = '<div class="empty-cart">Carrinho vazio. Adicione produtos para iniciar a venda.</div>';
        countEl.textContent = '0 itens';
        subtotalEl.textContent = 'R$ 0,00';
        totalEl.textContent = 'R$ 0,00';
        formaEl.textContent = 'Pix';
        return;
      }
      
      let html = '';
      let subtotal = 0;
      
      carrinho.forEach((item, index) => {
        const totalItem = item.quantidade * item.preco;
        subtotal += totalItem;
        
        html += `
          <div class="cart-item">
            <div class="desc">${item.descricao}</div>
            <div class="qty">${item.quantidade}x</div>
            <div class="price">${formatarMoeda(item.preco)}</div>
          </div>
        `;
      });
      
      container.innerHTML = html;
      countEl.textContent = `${carrinho.length} itens`;
      subtotalEl.textContent = formatarMoeda(subtotal);
      totalEl.textContent = formatarMoeda(subtotal);
      
      // Atualizar forma de pagamento
      const formas = {
        pix: 'Pix',
        credit: 'Cart√£o de Cr√©dito',
        debit: 'Cart√£o de D√©bito',
        money: 'Dinheiro'
      };
      formaEl.textContent = formas[formaPagamento] || 'Pix';
      
      // Atualizar c√°lculo de troco se for dinheiro
      atualizarTroco();
    }

    function adicionarAoCarrinho(produto) {
      const existente = carrinho.find(i => i.produto_id === produto.id);
      if (existente) {
        existente.quantidade += 1;
      } else {
        carrinho.push({
          produto_id: produto.id,
          descricao: produto.descricao,
          quantidade: 1,
          preco: produto.preco_venda
        });
      }
      atualizarCarrinho();
      document.getElementById('busca-produto').value = '';
      document.getElementById('barcode-input').value = '';
    }

    // ========== FORMAS DE PAGAMENTO ==========
    document.querySelectorAll('.payment-option').forEach(option => {
      option.addEventListener('click', () => {
        document.querySelectorAll('.payment-option').forEach(o => o.classList.remove('selected'));
        option.classList.add('selected');
        formaPagamento = option.getAttribute('data-payment');
        
        // Mostrar/ocultar campo de valor recebido
        const moneyInput = document.getElementById('payment-money-input');
        const trocoRow = document.getElementById('troco-row');
        
        if (formaPagamento === 'money') {
          moneyInput.classList.add('active');
          trocoRow.style.display = 'flex';
        } else {
          moneyInput.classList.remove('active');
          trocoRow.style.display = 'none';
          document.getElementById('valor-recebido').value = '';
        }
        
        atualizarCarrinho();
      });
    });

    function atualizarTroco() {
      if (formaPagamento !== 'money') return;
      
      const valorRecebido = parseFloat(document.getElementById('valor-recebido').value) || 0;
      const total = carrinho.reduce((sum, item) => sum + (item.quantidade * item.preco), 0);
      const troco = valorRecebido - total;
      
      document.getElementById('troco-valor').textContent = formatarMoeda(troco);
    }

    document.getElementById('valor-recebido').addEventListener('input', atualizarTroco);

    // ========== CLIENTES ==========
    function carregarClientesModal() {
      const db = buscarDados();
      const lista = document.getElementById('lista-clientes-modal');
      lista.innerHTML = '';
      
      if (db.clientes.length === 0) {
        lista.innerHTML = '<div style="padding:15px; text-align:center; color:#999">Nenhum cliente cadastrado</div>';
        return;
      }
      
      db.clientes.forEach(c => {
        const div = document.createElement('div');
        div.className = 'client-item';
        div.innerHTML = `
          <div class="name">${c.nome}</div>
          <div class="doc">${formatarDocumento(c.documento, c.tipo)}</div>
        `;
        div.addEventListener('click', () => selecionarCliente(c));
        lista.appendChild(div);
      });
    }

    function selecionarCliente(cliente) {
      clienteSelecionado = cliente;
      document.getElementById('cliente-selecionado').innerHTML = `
        <div class="client-selected">
          <div class="name">${cliente.nome}</div>
          <div class="doc">${formatarDocumento(cliente.documento, cliente.tipo)}</div>
        </div>
      `;
      document.getElementById('modal-selecionar-cliente').style.display = 'none';
    }

    // ========== LEITOR DE C√ìDIGO DE BARRAS ==========
    document.getElementById('barcode-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const codigo = document.getElementById('barcode-input').value.trim();
        
        if (codigo) {
          const db = buscarDados();
          const produto = db.produtos.find(p => 
            p.codigo_barra === codigo || 
            p.codigo === codigo ||
            p.descricao.toLowerCase().includes(codigo.toLowerCase())
          );
          
          if (produto && produto.ativo !== false) {
            adicionarAoCarrinho(produto);
            BackupSystem.mostrarNotificacao(`‚úÖ ${produto.descricao} adicionado ao carrinho!`, 'success');
          } else {
            BackupSystem.mostrarNotificacao('‚ùå Produto n√£o encontrado!', 'error');
          }
          
          document.getElementById('barcode-input').value = '';
        }
      }
    });

    // ========== VENDAS ==========
    document.getElementById('btn-finalizar').addEventListener('click', () => {
      if (carrinho.length === 0) {
        alert('‚ö†Ô∏è Adicione produtos ao carrinho antes de finalizar!');
        return;
      }
      
      const total = carrinho.reduce((sum, item) => sum + (item.quantidade * item.preco), 0);
      
      // Validar valor recebido se for dinheiro
      if (formaPagamento === 'money') {
        const valorRecebido = parseFloat(document.getElementById('valor-recebido').value) || 0;
        if (valorRecebido < total) {
          alert(`‚ö†Ô∏è Valor recebido (R$ ${valorRecebido.toFixed(2)}) √© menor que o total (R$ ${total.toFixed(2)})!`);
          return;
        }
      }
      
      let msg = `‚úÖ Confirmar venda no valor de ${formatarMoeda(total)}?`;
      if (clienteSelecionado) {
        msg = `‚úÖ Confirmar venda para ${clienteSelecionado.nome} no valor de ${formatarMoeda(total)}?`;
      }
      
      if (!confirm(msg)) return;
      
      const db = buscarDados();
      db.config.ultimoIdVenda = (db.config.ultimoIdVenda || 0) + 1;
      
      // Calcular troco se for dinheiro
      let valorRecebido = null;
      let troco = 0;
      if (formaPagamento === 'money') {
        valorRecebido = parseFloat(document.getElementById('valor-recebido').value) || 0;
        troco = valorRecebido - total;
      }
      
      const novaVenda = {
        id: db.config.ultimoIdVenda,
         new Date().toISOString(),
        usuario_id: parseInt(sessionStorage.getItem('user_id')),
        cliente_id: clienteSelecionado ? clienteSelecionado.id : null,
        total: total,
        forma_pagamento: formaPagamento,
        valor_recebido: valorRecebido,
        troco: troco,
        itens: carrinho.map(item => ({...item}))
      };
      
      db.vendas.push(novaVenda);
      salvarDados(db);
      
      // Gerar cupom
      CupomFiscal.gerar(novaVenda);
      
      // Limpar carrinho e cliente
      carrinho = [];
      clienteSelecionado = null;
      formaPagamento = 'pix';
      document.getElementById('cliente-selecionado').innerHTML = '<div style="color: #7f8c8d; font-style: italic;">Nenhum cliente selecionado</div>';
      document.getElementById('valor-recebido').value = '';
      document.querySelectorAll('.payment-option').forEach(o => o.classList.remove('selected'));
      document.querySelector('.payment-option[data-payment="pix"]').classList.add('selected');
      atualizarCarrinho();
    });

    // ========== CONSULTAR VENDA POR CUPOM ==========
    document.getElementById('btn-buscar-cupom').addEventListener('click', () => {
      const numero = document.getElementById('numero-cupom').value.trim();
      if (!numero) {
        alert('‚ö†Ô∏è Informe o n√∫mero do cupom!');
        return;
      }
      
      const sucesso = CupomFiscal.consultarPorNumero(numero);
      if (sucesso) {
        BackupSystem.mostrarNotificacao('‚úÖ Cupom encontrado!', 'success');
      }
    });

    document.getElementById('btn-imprimir-consulta').addEventListener('click', () => {
      window.print();
    });

    document.getElementById('btn-fechar-consulta').addEventListener('click', () => {
      document.getElementById('modal-consultar-venda').style.display = 'none';
      document.getElementById('resultado-cupom').style.display = 'none';
      document.getElementById('btn-imprimir-consulta').style.display = 'none';
      document.getElementById('numero-cupom').value = '';
    });

    // ========== SANGRIA ==========
    document.getElementById('btn-sangria').addEventListener('click', () => {
      document.getElementById('modal-sangria').style.display = 'flex';
      document.getElementById('valor-sangria').focus();
    });

    document.getElementById('btn-cancelar-sangria').addEventListener('click', () => {
      document.getElementById('modal-sangria').style.display = 'none';
    });

    document.getElementById('btn-confirmar-sangria').addEventListener('click', () => {
      const valor = parseFloat(document.getElementById('valor-sangria').value);
      const especificacao = document.getElementById('especificacao-sangria').value;
      const senha = document.getElementById('senha-admin-sangria').value;
      
      if (!valor || valor <= 0) {
        alert('‚ö†Ô∏è Informe um valor v√°lido para a sangria!');
        return;
      }
      
      if (senha !== 'java1814') {
        alert('‚ùå Senha de administrador inv√°lida! Tente novamente.');
        return;
      }
      
      const db = buscarDados();
      db.movimentacoes.push({
        id: Date.now(),
         new Date().toISOString(),
        usuario_id: parseInt(sessionStorage.getItem('user_id')),
        tipo: 'sangria',
        valor: valor,
        especificacao: especificacao,
        senha_admin: senha
      });
      
      salvarDados(db);
      
      alert(`‚úÖ Sangria de ${formatarMoeda(valor)} registrada com sucesso!`);
      document.getElementById('modal-sangria').style.display = 'none';
      document.getElementById('valor-sangria').value = '';
      document.getElementById('especificacao-sangria').value = '';
      document.getElementById('senha-admin-sangria').value = '';
    });

    // ========== CANCELAR VENDA ==========
    document.getElementById('btn-cancelar').addEventListener('click', () => {
      if (carrinho.length === 0) {
        alert('‚ÑπÔ∏è Carrinho j√° est√° vazio');
        return;
      }
      
      if (confirm('‚ö†Ô∏è Deseja cancelar esta venda? Todos os itens ser√£o removidos.')) {
        carrinho = [];
        clienteSelecionado = null;
        document.getElementById('cliente-selecionado').innerHTML = '<div style="color: #7f8c8d; font-style: italic;">Nenhum cliente selecionado</div>';
        atualizarCarrinho();
        alert('‚úÖ Venda cancelada com sucesso!');
      }
    });

    // ========== LEITURA Z ==========
    document.getElementById('btn-leitura-z').addEventListener('click', () => {
      document.getElementById('modal-leitura-z').style.display = 'flex';
      
      const hoje = new Date().toISOString().split('T')[0];
      document.getElementById('data-inicio-zreport').value = hoje;
      document.getElementById('data-fim-zreport').value = hoje;
    });

    document.getElementById('btn-gerar-zreport').addEventListener('click', () => {
      const dataInicio = document.getElementById('data-inicio-zreport').value;
      const dataFim = document.getElementById('data-fim-zreport').value;
      
      if (!dataInicio || !dataFim) {
        alert('‚ö†Ô∏è Selecione ambas as datas!');
        return;
      }
      
      LeituraZ.gerarRelatorio(dataInicio, dataFim);
    });

    document.getElementById('btn-imprimir-zreport').addEventListener('click', () => {
      LeituraZ.imprimir();
    });

    document.getElementById('btn-exportar-zreport').addEventListener('click', () => {
      LeituraZ.exportarPDF();
    });

    document.getElementById('btn-fechar-zreport').addEventListener('click', () => {
      document.getElementById('modal-leitura-z').style.display = 'none';
      document.getElementById('zreport-container').style.display = 'none';
    });

    // ========== CUPOM ==========
    document.getElementById('btn-imprimir-cupom').addEventListener('click', () => {
      CupomFiscal.imprimir();
    });

    document.getElementById('btn-whatsapp-cupom').addEventListener('click', () => {
      // Reenviar cupom atual para WhatsApp
      const db = buscarDados();
      const ultimaVenda = db.vendas[db.vendas.length - 1];
      if (ultimaVenda) {
        CupomFiscal.enviarWhatsApp(ultimaVenda);
      }
    });

    document.getElementById('btn-fechar-cupom').addEventListener('click', () => {
      document.getElementById('modal-cupom').style.display = 'none';
    });

    document.getElementById('btn-reimprimir-cupom').addEventListener('click', () => {
      CupomFiscal.reimprimir();
    });

    // ========== MODALS ==========
    document.getElementById('btn-selecionar-cliente').addEventListener('click', () => {
      document.getElementById('modal-selecionar-cliente').style.display = 'flex';
      carregarClientesModal();
      document.getElementById('busca-cliente-modal').focus();
    });

    document.getElementById('btn-fechar-cliente').addEventListener('click', () => {
      document.getElementById('modal-selecionar-cliente').style.display = 'none';
    });

    document.getElementById('btn-remover-cliente').addEventListener('click', () => {
      clienteSelecionado = null;
      document.getElementById('cliente-selecionado').innerHTML = '<div style="color: #7f8c8d; font-style: italic;">Nenhum cliente selecionado</div>';
      document.getElementById('modal-selecionar-cliente').style.display = 'none';
    });

    document.getElementById('btn-clientes-menu').addEventListener('click', () => {
      document.getElementById('modal-clientes').style.display = 'flex';
      carregarListaClientes();
    });

    document.getElementById('btn-produtos-menu').addEventListener('click', () => {
      document.getElementById('modal-produtos').style.display = 'flex';
      carregarListaProdutosModal();
    });

    document.getElementById('btn-backup').addEventListener('click', () => {
      document.getElementById('modal-backup').style.display = 'flex';
      BackupSystem.carregarHistoricoBackups();
    });

    document.getElementById('btn-fechar-clientes').addEventListener('click', () => {
      document.getElementById('modal-clientes').style.display = 'none';
    });

    document.getElementById('btn-fechar-produtos').addEventListener('click', () => {
      document.getElementById('modal-produtos').style.display = 'none';
    });

    document.getElementById('btn-fechar-backup').addEventListener('click', () => {
      document.getElementById('modal-backup').style.display = 'none';
    });

    // Fechar modals ao clicar fora
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.style.display = 'none';
      });
    });

    // ========== TABS ==========
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.getAttribute('data-tab');
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        tab.classList.add('active');
        
        // Backup tabs
        if (tabName === 'backup-manual') {
          document.getElementById('tab-backup-manual').classList.add('active');
        } else if (tabName === 'backup-historico') {
          document.getElementById('tab-backup-historico').classList.add('active');
          BackupSystem.carregarHistoricoBackups();
        } else if (tabName === 'backup-restaurar') {
          document.getElementById('tab-backup-restaurar').classList.add('active');
        } else if (tabName === 'backup-config') {
          document.getElementById('tab-backup-config').classList.add('active');
          const config = JSON.parse(localStorage.getItem('backup_config'));
          document.querySelector(`input[name="backup-auto"][value="${config.auto}"]`).checked = true;
          document.getElementById('backup-hora').value = config.hora;
          document.getElementById('max-backups').value = config.maxBackups;
        } 
        // Clientes tabs
        else if (tabName === 'lista') {
          document.getElementById('tab-lista-clientes').classList.add('active');
          carregarListaClientes();
        } else if (tabName === 'novo') {
          document.getElementById('tab-novo-cliente').classList.add('active');
          document.getElementById('cliente-nome').focus();
        } 
        // Produtos tabs
        else if (tabName === 'lista-prod') {
          document.getElementById('tab-lista-produtos').classList.add('active');
          carregarListaProdutosModal();
        } else if (tabName === 'novo-prod') {
          document.getElementById('tab-novo-produto').classList.add('active');
          document.getElementById('produto-descricao').focus();
        }
      });
    });

    // ========== BACKUP BUTTONS ==========
    document.getElementById('btn-criar-backup').addEventListener('click', () => {
      BackupSystem.criarBackup();
    });

    document.getElementById('btn-limpar-historico').addEventListener('click', () => {
      BackupSystem.limparHistorico();
    });

    document.getElementById('arquivo-restore').addEventListener('change', (e) => {
      BackupSystem.restaurarDeArquivo(e);
    });

    document.getElementById('btn-restaurar-arquivo').addEventListener('click', () => {
      const fileInput = document.getElementById('arquivo-restore');
      if (!fileInput.files.length) {
        BackupSystem.mostrarNotificacao('‚ö†Ô∏è Selecione um arquivo de backup primeiro!', 'warning');
        return;
      }
      BackupSystem.restaurarDeArquivo({ target: fileInput });
    });

    document.getElementById('btn-salvar-config').addEventListener('click', () => {
      BackupSystem.salvarConfiguracoes();
    });

    // ========== CRUD CLIENTES ==========
    function carregarListaClientes() {
      const db = buscarDados();
      const busca = document.getElementById('busca-clientes-lista').value.toLowerCase();
      const container = document.getElementById('container-clientes-lista');
      
      const clientesFiltrados = db.clientes.filter(c => 
        c.nome.toLowerCase().includes(busca) || 
        c.documento.includes(busca.replace(/\D/g, ''))
      );
      
      if (clientesFiltrados.length === 0) {
        container.innerHTML = '<div class="empty">Nenhum cliente encontrado</div>';
        return;
      }
      
      let html = '<table style="width:100%; border-collapse:collapse;">';
      html += '<thead><tr><th>Nome</th><th>Documento</th><th>Tipo</th><th>A√ß√µes</th></tr></thead><tbody>';
      
      clientesFiltrados.forEach(c => {
        html += `
          <tr style="border-bottom:1px solid #eee;">
            <td>${c.nome}</td>
            <td>${formatarDocumento(c.documento, c.tipo)}</td>
            <td><span class="badge badge-${c.tipo}">${c.tipo.toUpperCase()}</span></td>
            <td>
              <button class="btn btn-sm" style="padding:4px 8px; font-size:12px; background:#3498db; color:white; margin-right:5px;" onclick="editarCliente(${c.id})">‚úèÔ∏è</button>
              <button class="btn btn-sm" style="padding:4px 8px; font-size:12px; background:#e74c3c; color:white;" onclick="excluirCliente(${c.id})">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    window.editarCliente = function(id) {
      const db = buscarDados();
      const cliente = db.clientes.find(c => c.id === id);
      if (!cliente) return;
      
      document.querySelector('[data-tab="novo"]').click();
      
      document.getElementById('cliente-nome').value = cliente.nome;
      document.getElementById('cliente-tipo').value = cliente.tipo;
      document.getElementById('cliente-documento').value = formatarDocumento(cliente.documento, cliente.tipo);
      document.getElementById('cliente-telefone').value = cliente.telefone || '';
      document.getElementById('cliente-email').value = cliente.email || '';
      document.getElementById('cliente-endereco').value = cliente.endereco || '';
      
      document.getElementById('btn-salvar-cliente').setAttribute('data-editando', id);
    };

    window.excluirCliente = function(id) {
      VerificacaoSenha.verificar((autorizado) => {
        if (!autorizado) {
          BackupSystem.mostrarNotificacao('‚ùå Opera√ß√£o cancelada!', 'warning');
          return;
        }
        
        if (!confirm('‚ö†Ô∏è Deseja realmente excluir este cliente?')) return;
        
        const db = buscarDados();
        db.clientes = db.clientes.filter(c => c.id !== id);
        salvarDados(db);
        
        BackupSystem.mostrarNotificacao('‚úÖ Cliente exclu√≠do com sucesso!', 'success');
        carregarListaClientes();
      });
    };

    document.getElementById('btn-salvar-cliente').addEventListener('click', () => {
      const nome = document.getElementById('cliente-nome').value.trim();
      const tipo = document.getElementById('cliente-tipo').value;
      const documento = document.getElementById('cliente-documento').value.replace(/\D/g, '');
      const telefone = document.getElementById('cliente-telefone').value.replace(/\D/g, '');
      const email = document.getElementById('cliente-email').value.trim();
      const endereco = document.getElementById('cliente-endereco').value.trim();
      
      if (!nome) {
        alert('‚ö†Ô∏è O nome √© obrigat√≥rio!');
        return;
      }
      
      if (documento.length < (tipo === 'cpf' ? 11 : 14)) {
        alert(`‚ö†Ô∏è O ${tipo.toUpperCase()} deve estar completo!`);
        return;
      }
      
      const db = buscarDados();
      const editandoId = document.getElementById('btn-salvar-cliente').getAttribute('data-editando');
      
      if (editandoId) {
        const cliente = db.clientes.find(c => c.id === parseInt(editandoId));
        if (cliente) {
          cliente.nome = nome;
          cliente.tipo = tipo;
          cliente.documento = documento;
          cliente.telefone = telefone;
          cliente.email = email;
          cliente.endereco = endereco;
          BackupSystem.mostrarNotificacao('‚úÖ Cliente atualizado com sucesso!', 'success');
        }
      } else {
        db.config.ultimoIdCliente = (db.config.ultimoIdCliente || 0) + 1;
        db.clientes.push({
          id: db.config.ultimoIdCliente,
          nome: nome,
          tipo: tipo,
          documento: documento,
          telefone: telefone,
          email: email,
          endereco: endereco
        });
        BackupSystem.mostrarNotificacao('‚úÖ Cliente cadastrado com sucesso!', 'success');
      }
      
      salvarDados(db);
      document.getElementById('btn-salvar-cliente').removeAttribute('data-editando');
      document.querySelector('[data-tab="lista"]').click();
      carregarListaClientes();
    });

    document.getElementById('busca-clientes-lista').addEventListener('input', carregarListaClientes);

    // ========== CRUD PRODUTOS ==========
    function carregarListaProdutosModal() {
      const db = buscarDados();
      const busca = document.getElementById('busca-produtos-lista').value.toLowerCase();
      const container = document.getElementById('container-produtos-lista');
      
      const produtosFiltrados = db.produtos.filter(p => 
        p.descricao.toLowerCase().includes(busca) || 
        (p.codigo && p.codigo.includes(busca)) ||
        (p.codigo_barra && p.codigo_barra.includes(busca))
      );
      
      if (produtosFiltrados.length === 0) {
        container.innerHTML = '<div class="empty">Nenhum produto encontrado</div>';
        return;
      }
      
      let html = '<table style="width:100%; border-collapse:collapse;">';
      html += '<thead><tr><th>C√≥digo</th><th>Descri√ß√£o</th><th>C√≥digo Barras</th><th>Pre√ßo</th><th>Estoque</th><th>A√ß√µes</th></tr></thead><tbody>';
      
      produtosFiltrados.forEach(p => {
        html += `
          <tr style="border-bottom:1px solid #eee;">
            <td>${p.codigo || '-'}</td>
            <td>${p.descricao}</td>
            <td>${p.codigo_barra || '-'}</td>
            <td>${formatarMoeda(p.preco_venda)}</td>
            <td>${p.estoque}</td>
            <td>
              <button class="btn btn-sm" style="padding:4px 8px; font-size:12px; background:#e74c3c; color:white;" onclick="excluirProduto(${p.id})">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    window.excluirProduto = function(id) {
      VerificacaoSenha.verificar((autorizado) => {
        if (!autorizado) {
          BackupSystem.mostrarNotificacao('‚ùå Opera√ß√£o cancelada!', 'warning');
          return;
        }
        
        if (!confirm('‚ö†Ô∏è Deseja realmente excluir este produto?')) return;
        
        const db = buscarDados();
        db.produtos = db.produtos.filter(p => p.id !== id);
        salvarDados(db);
        
        BackupSystem.mostrarNotificacao('‚úÖ Produto exclu√≠do com sucesso!', 'success');
        carregarListaProdutosModal();
        carregarProdutos();
      });
    };

    document.getElementById('btn-salvar-produto').addEventListener('click', () => {
      const codigo = document.getElementById('produto-codigo').value.trim();
      const codigoBarra = document.getElementById('produto-codigo-barra').value.trim();
      const descricao = document.getElementById('produto-descricao').value.trim();
      const preco = parseFloat(document.getElementById('produto-preco').value);
      const estoque = parseInt(document.getElementById('produto-estoque').value) || 0;
      
      if (!descricao || !preco) {
        alert('‚ö†Ô∏è Descri√ß√£o e pre√ßo s√£o obrigat√≥rios!');
        return;
      }
      
      const db = buscarDados();
      db.config.ultimoIdProduto = (db.config.ultimoIdProduto || 0) + 1;
      
      db.produtos.push({
        id: db.config.ultimoIdProduto,
        codigo: codigo || null,
        codigo_barra: codigoBarra || null,
        descricao: descricao,
        preco_venda: preco,
        estoque: estoque,
        ativo: true
      });
      
      salvarDados(db);
      BackupSystem.mostrarNotificacao('‚úÖ Produto cadastrado com sucesso!', 'success');
      
      document.getElementById('produto-codigo').value = '';
      document.getElementById('produto-codigo-barra').value = '';
      document.getElementById('produto-descricao').value = '';
      document.getElementById('produto-preco').value = '';
      document.getElementById('produto-estoque').value = '0';
      
      document.querySelector('[data-tab="lista-prod"]').click();
      carregarListaProdutosModal();
      carregarProdutos();
    });

    document.getElementById('busca-produtos-lista').addEventListener('input', carregarListaProdutosModal);

    // ========== ATALHOS DE TECLADO ==========
    document.addEventListener('keydown', (e) => {
      if (document.getElementById('screen-login').style.display !== 'none') {
        if (e.key === 'Enter') document.getElementById('btn-login').click();
        return;
      }
      
      if (e.key === 'F2' || e.key === 'f2') {
        e.preventDefault();
        document.getElementById('busca-produto').focus();
        document.getElementById('busca-produto').select();
      }
      
      if (e.key === 'F3' || e.key === 'f3') {
        e.preventDefault();
        document.getElementById('btn-finalizar').click();
      }
      
      if (e.key === 'F4' || e.key === 'f4') {
        e.preventDefault();
        document.getElementById('btn-sangria').click();
      }
      
      if (e.key === 'Escape') {
        e.preventDefault();
        if (carrinho.length > 0 && confirm('Deseja limpar o carrinho?')) {
          carrinho = [];
          clienteSelecionado = null;
          document.getElementById('cliente-selecionado').innerHTML = '<div style="color: #7f8c8d; font-style: italic;">Nenhum cliente selecionado</div>';
          atualizarCarrinho();
        }
        document.getElementById('busca-produto').focus();
      }
    });

    // ========== INICIALIZA√á√ÉO ==========
    inicializarDados();
    
    if (sessionStorage.getItem('user_id')) {
      document.getElementById('user-name').textContent = sessionStorage.getItem('user_nome');
      document.getElementById('screen-login').style.display = 'none';
      document.getElementById('screen-vendas').style.display = 'block';
      carregarProdutos();
      BackupSystem.atualizarStatus();
      BackupSystem.atualizarTimer();
    }
    
    setInterval(() => {
      BackupSystem.verificarBackupAutomatico();
      BackupSystem.atualizarTimer();
    }, 60000);
    
    setTimeout(() => {
      if (document.getElementById('screen-login').style.display !== 'none') {
        alert('üëã Bem-vindo ao Sistema de Vendas Completo!\n\n‚úÖ Formas de pagamento (Pix, Cart√£o, Dinheiro)\n‚úÖ C√°lculo autom√°tico de troco\n‚úÖ Leitor de c√≥digo de barras\n‚úÖ Consulta de cupom por n√∫mero\n‚úÖ Cupom enviado automaticamente para WhatsApp\n‚úÖ Backup autom√°tico di√°rio\n‚úÖ Senha admin: java1814\n\nüí¨ Seu cupom vai direto para o WhatsApp ap√≥s cada venda!');
      }
    }, 1000);
  </script>
</body>
</html>
