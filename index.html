<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üõí Sistema de Vendas - Armarinho Completo</title>
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<style>
:root {
  --primary: #3498db;
  --success: #2ecc71;
  --danger: #e74c3c;
  --warning: #f39c12;
  --dark: #2c3e50;
  --light: #ecf0f1;
  --backup: #9b59b6;
  --zreport: #34495e;
  --whatsapp: #25D366;
  --barcode: #9b59b6;
  --stock-low: #e74c3c;
  --stock-medium: #f39c12;
  --stock-high: #2ecc71;
}
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
body {
  background: #f5f7fa;
  color: #333;
  height: 100vh;
  overflow: hidden;
}
.header {
  background: var(--dark);
  color: white;
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  position: relative;
  z-index: 100;
}
.logo {
  font-size: 24px;
  font-weight: bold;
  display: flex;
  align-items: center;
  gap: 10px;
}
.container {
  display: flex;
  height: calc(100vh - 70px);
}
.sidebar {
  width: 350px;
  background: white;
  border-right: 1px solid #ddd;
  padding: 20px;
  overflow-y: auto;
}
.search-box {
  margin-bottom: 20px;
  position: relative;
}
.search-box input {
  width: 100%;
  padding: 14px;
  border: 2px solid #ddd;
  border-radius: 8px;
  font-size: 16px;
}
.search-box input:focus {
  border-color: var(--primary);
  outline: none;
}
.payment-box {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 20px;
  border: 2px solid var(--warning);
}
.payment-box .label {
  font-weight: bold;
  color: #7f8c8d;
  margin-bottom: 10px;
  display: block;
}
.payment-options {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 15px;
}
.payment-option {
  padding: 10px;
  border: 2px solid #ddd;
  border-radius: 6px;
  cursor: pointer;
  text-align: center;
  transition: all 0.2s;
}
.payment-option:hover {
  border-color: var(--primary);
  background: #f8f9fa;
}
.payment-option.selected {
  border-color: var(--primary);
  background: #e3f2fd;
  font-weight: bold;
}
.payment-option i {
  font-size: 24px;
  margin-bottom: 5px;
  display: block;
}
.payment-input {
  display: none;
}
.payment-input.active {
  display: block;
  margin-top: 10px;
}
.client-box {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 20px;
}
.client-box .label {
  font-weight: bold;
  color: #7f8c8d;
  margin-bottom: 8px;
  display: block;
}
.client-selected {
  background: #e3f2fd;
  padding: 12px;
  border-radius: 6px;
  margin-top: 10px;
}
.client-selected .name {
  font-weight: bold;
  color: #2980b9;
}
.btn-client {
  background: var(--success);
  color: white;
  border: none;
  padding: 8px 15px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  width: 100%;
  margin-top: 10px;
}
.btn-client:hover {
  background: #27ae60;
}
.products-list {
  max-height: 250px;
  overflow-y: auto;
}
.product-item {
  padding: 12px;
  border-bottom: 1px solid #eee;
  cursor: pointer;
  transition: background 0.2s;
}
.product-item:hover {
  background: #f8f9fa;
}
.product-item .name {
  font-weight: 500;
}
.product-item .price {
  color: var(--primary);
  font-weight: bold;
  margin-top: 4px;
}
.cart {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: #f8f9fa;
  padding: 20px;
}
.cart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}
.cart-title {
  font-size: 24px;
  font-weight: bold;
  color: var(--dark);
}
.cart-items {
  background: white;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  flex: 1;
  overflow-y: auto;
}
.cart-item {
  padding: 15px;
  border-bottom: 1px solid #eee;
  display: flex;
  justify-content: space-between;
}
.cart-item:last-child {
  border-bottom: none;
}
.cart-item .desc {
  flex: 2;
}
.cart-item .qty {
  flex: 1;
  text-align: center;
  color: #7f8c8d;
}
.cart-item .price {
  flex: 1;
  text-align: right;
  font-weight: bold;
}
.cart-total {
  background: white;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  padding: 20px;
  margin-top: 20px;
}
.total-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
  font-size: 18px;
}
.total-row.final {
  font-size: 24px;
  font-weight: bold;
  color: var(--primary);
  margin-top: 15px;
  padding-top: 15px;
  border-top: 2px solid #eee;
}
.total-row.change {
  color: var(--success);
  font-weight: bold;
}
.actions {
  display: flex;
  gap: 15px;
  margin-top: 25px;
}
.btn {
  padding: 15px 25px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-primary {
  background: var(--primary);
  color: white;
  flex: 1;
}
.btn-primary:hover {
  background: #2980b9;
}
.btn-danger {
  background: var(--danger);
  color: white;
}
.btn-danger:hover {
  background: #c0392b;
}
.btn-warning {
  background: var(--warning);
  color: white;
}
.btn-warning:hover {
  background: #e67e22;
}
.btn-backup {
  background: var(--backup);
  color: white;
}
.btn-backup:hover {
  background: #8e44ad;
}
.btn-zreport {
  background: var(--zreport);
  color: white;
}
.btn-zreport:hover {
  background: #2c3e50;
}
.btn-barcode-modal {
  background: var(--barcode);
  color: white;
  border: none;
  padding: 12px 25px;
  border-radius: 12px;
  font-weight: bold;
  font-size: 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 15px 0;
  box-shadow: 0 4px 10px rgba(155, 89, 182, 0.4);
  width: 100%;
}
.btn-barcode-modal:hover {
  background: #8e44ad;
  transform: translateY(-2px);
}
.btn-stock {
  background: #9b59b6;
  color: white;
}
.btn-stock:hover {
  background: #8e44ad;
}
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  justify-content: center;
  align-items: center;
}
.modal-content {
  background: white;
  padding: 30px;
  border-radius: 15px;
  width: 90%;
  max-width: 700px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  position: relative;
  max-height: 90vh;
  overflow-y: auto;
}
.modal h3 {
  margin-bottom: 20px;
  color: var(--dark);
  text-align: center;
}
.form-group {
  margin-bottom: 15px;
  text-align: left;
}
.form-group label {
  display: block;
  margin-bottom: 8px;
  color: #7f8c8d;
  font-weight: 500;
}
.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 12px;
  border: 2px solid #ddd;
  border-radius: 8px;
  font-size: 16px;
}
.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  border-color: var(--primary);
  outline: none;
}
.modal-buttons {
  display: flex;
  gap: 15px;
  margin-top: 20px;
  margin-bottom: 20px;
}
.empty-cart {
  padding: 30px;
  text-align: center;
  color: #999;
}
.login-container {
  background: white;
  border-radius: 15px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  padding: 40px;
  width: 100%;
  max-width: 400px;
  text-align: center;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}
.login-title {
  color: var(--dark);
  margin-bottom: 30px;
  font-size: 28px;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px;
}
.login-title i {
  font-size: 32px;
}
.error {
  color: var(--danger);
  background: #fadbd8;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 20px;
  display: none;
}
.user-select {
  width: 100%;
  padding: 14px;
  border: 2px solid #ddd;
  border-radius: 8px;
  font-size: 16px;
  background: white;
  cursor: pointer;
  margin-bottom: 15px;
}
.user-select:focus {
  border-color: var(--primary);
  outline: none;
  box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
}
#scanner-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.95);
  z-index: 9999;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  padding: 20px;
}
#scanner-modal.active {
  display: flex;
}
#reader {
  width: 100%;
  max-width: 400px;
  margin-bottom: 20px;
  background: white;
  border-radius: 15px;
  padding: 15px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
.scanner-header {
  background: #2c3e50;
  color: white;
  padding: 15px;
  border-radius: 12px 12px 0 0;
  text-align: center;
  margin-bottom: 15px;
  font-weight: bold;
  font-size: 18px;
}
.scanner-close-btn {
  background: #dc2626;
  color: white;
  border: none;
  padding: 12px 30px;
  border-radius: 12px;
  font-weight: bold;
  font-size: 16px;
  cursor: pointer;
  margin-top: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}
.scanner-close-btn:hover {
  background: #b91c1c;
  transform: translateY(-2px);
}
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background: white;
  padding: 15px 25px;
  border-radius: 8px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  z-index: 9999;
  display: flex;
  align-items: center;
  gap: 10px;
  border-left: 4px solid var(--success);
}
.notification.error {
  border-left-color: var(--danger);
}
.notification.warning {
  border-left-color: var(--warning);
}
.notification i {
  font-size: 20px;
}
.status-bar {
  background: #2c3e50;
  color: white;
  padding: 8px 20px;
  font-size: 14px;
  text-align: center;
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 1000;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.tabs {
  display: flex;
  margin-bottom: 20px;
  border-bottom: 2px solid #ddd;
}
.tab {
  padding: 12px 20px;
  cursor: pointer;
  font-weight: 500;
}
.tab.active {
  border-bottom: 3px solid var(--primary);
  color: var(--primary);
}
.tab-content {
  display: none;
}
.tab-content.active {
  display: block;
}
.barcode-reader {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 15px;
  border: 2px dashed var(--barcode);
}
.barcode-reader .label {
  font-weight: bold;
  color: var(--barcode);
  margin-bottom: 10px;
  display: block;
  text-align: center;
}
.barcode-reader input {
  width: 100%;
  padding: 12px;
  border: 2px solid var(--barcode);
  border-radius: 6px;
  font-size: 18px;
  text-align: center;
  font-weight: bold;
}
.client-list {
  max-height: 300px;
  overflow-y: auto;
  margin-top: 10px;
}
.client-item {
  padding: 10px;
  border-bottom: 1px solid #eee;
  cursor: pointer;
}
.client-item:hover {
  background: #f8f9fa;
}
.client-item .name {
  font-weight: 500;
}
.badge {
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: bold;
}
.badge-cpf {
  background: var(--primary);
  color: white;
}
.badge-cnpj {
  background: var(--success);
  color: white;
}
.badge-stock-low {
  background: var(--stock-low);
  color: white;
}
.badge-stock-medium {
  background: var(--stock-medium);
  color: white;
}
.badge-stock-high {
  background: var(--stock-high);
  color: white;
}
.stock-list {
  max-height: 500px;
  overflow-y: auto;
}
.stock-item {
  padding: 12px;
  border-bottom: 1px solid #eee;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.stock-item:last-child {
  border-bottom: none;
}
.stock-item .info {
  flex: 3;
}
.stock-item .info .name {
  font-weight: 500;
}
.stock-item .info .details {
  font-size: 12px;
  color: #7f8c8d;
  margin-top: 3px;
}
.stock-item .quantity {
  flex: 1;
  text-align: center;
  font-weight: bold;
  font-size: 16px;
}
.stock-item .actions {
  flex: 1;
  display: flex;
  gap: 8px;
}
.btn-sm {
  padding: 6px 10px;
  font-size: 12px;
}
.btn-sm.edit {
  background: #3498db;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
.btn-sm.remove {
  background: #e74c3c;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
@media (max-width: 900px) {
  .container {
    flex-direction: column;
  }
  .sidebar {
    width: 100%;
    height: auto;
    max-height: 40%;
  }
  .actions {
    flex-direction: column;
  }
}
</style>
</head>
<body>
<!-- Tela de Login -->
<div id="screen-login" class="screen" style="height:100vh; background: linear-gradient(135deg, #1a2a6c, #2c3e50); display:flex; align-items:center; justify-content:center;">
  <div class="login-container">
    <div class="login-title">
      <i>üõí</i> Sistema de Vendas Completo
    </div>
    <div id="error-login" class="error"></div>
    <div class="form-group">
      <label for="login-user" style="color:white;">üë§ Selecione o Usu√°rio</label>
      <select id="login-user" class="user-select">
        <option value="">----------</option>
        <option value="admin">üëë Administrador</option>
        <option value="operador">üë§ Operador</option>
      </select>
    </div>
    <div class="form-group">
      <label for="login-pass" style="color:white;">üîë Senha</label>
      <input type="password" id="login-pass" placeholder="Digite sua senha">
    </div>
    <button class="btn btn-primary" id="btn-login" style="width:100%; margin-top:20px;">üîê Entrar</button>
    <div style="margin-top:25px; color:#9b59b6; font-size:14px;">
      üîê Admin: *** | üë§ Operador: ***
    </div>
  </div>
</div>

<!-- Tela Principal (Vendas) -->
<div id="screen-vendas" class="screen" style="display:none;">
  <div class="header">
    <div class="logo">
      <i>üõí</i> Armarinho - <span id="user-name">Operador</span>
    </div>
    <div style="display: flex; gap: 10px;">
      <button class="btn btn-stock" id="btn-estoque" style="padding:8px 15px; font-size:14px; display:none;">
        üì¶ Estoque
      </button>
      <button class="btn btn-zreport" id="btn-leitura-z" style="padding:8px 15px; font-size:14px;">
        üìä Leitura Z
      </button>
      <button class="btn btn-backup" id="btn-backup" style="padding:8px 15px; font-size:14px;">
        üíæ Backup
      </button>
      <button class="btn btn-success" id="btn-clientes-menu" style="padding:8px 15px; font-size:14px; background:#2ecc71;">
        üë• Clientes
      </button>
      <button class="btn btn-warning" id="btn-produtos-menu" style="padding:8px 15px; font-size:14px; background:#f39c12;">
        üì¶ Produtos
      </button>
      <button class="btn btn-danger" id="btn-logout" style="padding:8px 15px; font-size:14px;">
        Sair
      </button>
    </div>
  </div>
  
  <div class="container">
    <div class="sidebar">
      <!-- Bot√£o Scanner de C√¢mera -->
      <button class="btn-barcode-modal" onclick="abrirScanner()">
        üì∑ üì± Ler C√≥digo com C√¢mera
      </button>
      
      <!-- Leitor de C√≥digo de Barras -->
      <div class="barcode-reader">
        <span class="label">üì± Leitor de C√≥digo de Barras</span>
        <input type="text" id="barcode-input" placeholder="Escaneie ou digite o c√≥digo..." autocomplete="off">
      </div>
      
      <div class="client-box">
        <span class="label">üë§ Cliente</span>
        <div id="cliente-selecionado">
          <div style="color: #7f8c8d; font-style: italic;">Nenhum cliente selecionado</div>
        </div>
        <button class="btn-client" id="btn-selecionar-cliente">Selecionar Cliente</button>
      </div>
      
      <div class="search-box">
        <input type="text" id="busca-produto" placeholder="Buscar produto...">
      </div>
      
      <div class="products-list" id="lista-produtos">
        <!-- Produtos ser√£o carregados aqui -->
      </div>
      
      <div style="background:#e3f2fd; color:#1976d2; padding:10px; border-radius:8px; margin-top:15px; text-align:center; font-size:14px;">
        <strong>Atalhos:</strong> F2 = Buscar | F3 = Finalizar | F4 = Sangria
      </div>
    </div>
    
    <div class="cart">
      <div class="cart-header">
        <div class="cart-title">Carrinho</div>
        <div id="cart-count">0 itens</div>
      </div>
      
      <div class="cart-items" id="itens-carrinho">
        <div class="empty-cart">Carrinho vazio. Adicione produtos para iniciar a venda.</div>
      </div>
      
      <!-- Formas de Pagamento -->
      <div class="payment-box">
        <span class="label">üí≥ Forma de Pagamento</span>
        <div class="payment-options">
          <div class="payment-option selected" data-payment="pix">
            <i>üì±</i>
            <div>Pix</div>
          </div>
          <div class="payment-option" data-payment="credit">
            <i>üí≥</i>
            <div>Cr√©dito</div>
          </div>
          <div class="payment-option" data-payment="debit">
            <i>üí≥</i>
            <div>D√©bito</div>
          </div>
          <div class="payment-option" data-payment="money">
            <i>üíµ</i>
            <div>Dinheiro</div>
          </div>
        </div>
        <div class="payment-input" id="payment-money-input">
          <div class="form-group">
            <label for="valor-recebido">Valor Recebido (R$)</label>
            <input type="number" id="valor-recebido" step="0.01" min="0.01" placeholder="Digite o valor recebido">
          </div>
          <div class="total-row change" id="troco-row" style="display:none;">
            <span>Troco:</span>
            <span id="troco-valor">R$ 0,00</span>
          </div>
        </div>
      </div>
      
      <div class="cart-total">
        <div class="total-row">
          <span>Subtotal:</span>
          <span id="subtotal">R$ 0,00</span>
        </div>
        <div class="total-row">
          <span>Forma:</span>
          <span id="forma-pagamento">Pix</span>
        </div>
        <div class="total-row final">
          <span>Total:</span>
          <span id="total">R$ 0,00</span>
        </div>
      </div>
      
      <div class="actions">
        <button class="btn btn-warning" id="btn-sangria">üí∞ Sangria</button>
        <button class="btn btn-danger" id="btn-cancelar">‚ùå Cancelar</button>
        <button class="btn btn-primary" id="btn-finalizar">‚úÖ Finalizar</button>
      </div>
    </div>
  </div>
  
  <div class="status-bar">
    <div id="backup-status">‚úÖ Sistema Online</div>
    <div>Sistema de Vendas - Armarinho</div>
  </div>
</div>

<!-- Modal Scanner de C√¢mera -->
<div id="scanner-modal">
  <div class="scanner-header">
    üì± Aponte a c√¢mera para o c√≥digo de barras
  </div>
  <div id="reader"></div>
  <button class="scanner-close-btn" onclick="fecharScanner()">‚ùå Fechar Scanner</button>
</div>

<!-- Modal Backup -->
<div class="modal" id="modal-backup">
  <div class="modal-content">
    <h3>üíæ Sistema de Backup</h3>
    <div class="tabs">
      <div class="tab active" data-tab="backup-manual">üì§ Backup Manual</div>
      <div class="tab" data-tab="backup-historico">üìã Hist√≥rico</div>
    </div>
    
    <div class="tab-content active" id="tab-backup-manual">
      <button class="btn btn-backup" id="btn-criar-backup" style="width:100%; padding:15px; font-size:18px; margin-bottom:20px;">
        üì§ Gerar Backup Agora
      </button>
      <button class="btn btn-primary" id="btn-download-backup" style="width:100%; padding:15px; font-size:18px; margin-bottom:20px; background:#2ecc71;">
        üíæ Baixar Backup (.json)
      </button>
      <div style="background:#e8f4fc; padding:15px; border-radius:8px;">
        <strong style="color:#2980b9;">‚ÑπÔ∏è Informa√ß√µes do Backup:</strong>
        <ul style="margin-top:10px; margin-left:20px; font-size:14px; color:#2c3e50;">
          <li>Clientes cadastrados</li>
          <li>Produtos e estoque</li>
          <li>Fornecedores</li>
          <li>Vendas realizadas</li>
          <li>Configura√ß√µes do sistema</li>
        </ul>
      </div>
    </div>
    
    <div class="tab-content" id="tab-backup-historico">
      <div class="backup-list" id="lista-backups">
        <!-- Backups ser√£o carregados aqui -->
      </div>
      <div id="backup-vazio" style="padding:30px; text-align:center; color:#999;">
        Nenhum backup encontrado
      </div>
    </div>
    
    <div class="modal-buttons">
      <button class="btn" id="btn-fechar-backup" style="flex:1; background:#95a5a6; color:white">Fechar</button>
    </div>
  </div>
</div>

<!-- Modal Leitura Z -->
<div class="modal" id="modal-leitura-z">
  <div class="modal-content">
    <h3>üìä Leitura Z - Relat√≥rio do Caixa</h3>
    <div class="form-group">
      <label for="data-inicio-zreport">Per√≠odo</label>
      <div style="display: flex; gap: 10px; margin-top: 8px;">
        <input type="date" id="data-inicio-zreport" style="flex: 1;">
        <span style="align-self: center;">at√©</span>
        <input type="date" id="data-fim-zreport" style="flex: 1;">
      </div>
    </div>
    <button class="btn btn-zreport" id="btn-gerar-zreport" style="width:100%; margin-top:15px;">
      üìä Gerar Relat√≥rio
    </button>
    <div id="zreport-container" style="display: none; margin-top:20px; background:#f8f9fa; padding:15px; border-radius:8px;">
      <div id="zreport-content">
        <!-- Relat√≥rio ser√° gerado aqui -->
      </div>
    </div>
    <div class="modal-buttons">
      <button class="btn" id="btn-fechar-zreport" style="flex:1; background:#95a5a6; color:white">Fechar</button>
    </div>
  </div>
</div>

<!-- Modal Clientes -->
<div class="modal" id="modal-clientes">
  <div class="modal-content">
    <h3>üë• Cadastro de Clientes</h3>
    <div class="tabs">
      <div class="tab active" data-tab="lista">üìã Lista</div>
      <div class="tab" data-tab="novo">‚ûï Novo</div>
    </div>
    
    <div class="tab-content active" id="tab-lista-clientes">
      <input type="text" id="busca-clientes-lista" placeholder="Buscar clientes..." style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;">
      <div id="container-clientes-lista" style="max-height:350px; overflow-y:auto;">
        <!-- Lista de clientes -->
      </div>
    </div>
    
    <div class="tab-content" id="tab-novo-cliente">
      <div class="form-group">
        <label for="cliente-nome">Nome Completo *</label>
        <input type="text" id="cliente-nome" placeholder="Ex: Maria Silva" required>
      </div>
      <div class="form-group">
        <label for="cliente-tipo">Tipo de Documento *</label>
        <select id="cliente-tipo">
          <option value="cpf">CPF (Pessoa F√≠sica)</option>
          <option value="cnpj">CNPJ (Pessoa Jur√≠dica)</option>
        </select>
      </div>
      <div class="form-group">
        <label for="cliente-documento">CPF/CNPJ *</label>
        <input type="text" id="cliente-documento" placeholder="Digite o CPF ou CNPJ" required maxlength="18">
      </div>
      <div class="form-group">
        <label for="cliente-whatsapp">WhatsApp *</label>
        <input type="text" id="cliente-whatsapp" placeholder="(00) 90000-0000" required>
      </div>
      <div class="form-group">
        <label for="cliente-telefone">Telefone (opcional)</label>
        <input type="text" id="cliente-telefone" placeholder="(00) 0000-0000">
      </div>
      <div class="form-group">
        <label for="cliente-email">Email (opcional)</label>
        <input type="email" id="cliente-email" placeholder="exemplo@email.com">
      </div>
      <div class="form-group">
        <label for="cliente-endereco">Endere√ßo (opcional)</label>
        <input type="text" id="cliente-endereco" placeholder="Rua, n√∫mero, bairro, cidade">
      </div>
    </div>
    
    <div class="modal-buttons">
      <button class="btn btn-danger" id="btn-fechar-clientes" style="flex:1; background:#95a5a6; color:white">Fechar</button>
      <button class="btn btn-success" id="btn-salvar-cliente" style="flex:1">üíæ Salvar Cliente</button>
    </div>
  </div>
</div>

<!-- Modal Produtos -->
<div class="modal" id="modal-produtos">
  <div class="modal-content">
    <h3>üì¶ Cadastro de Produtos</h3>
    <div class="tabs">
      <div class="tab active" data-tab="lista-prod">üìã Lista</div>
      <div class="tab" data-tab="novo-prod">‚ûï Novo</div>
    </div>
    
    <div class="tab-content active" id="tab-lista-produtos">
      <input type="text" id="busca-produtos-lista" placeholder="Buscar produtos..." style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;">
      <div id="container-produtos-lista" style="max-height:350px; overflow-y:auto;">
        <!-- Lista de produtos -->
      </div>
    </div>
    
    <div class="tab-content" id="tab-novo-produto">
      <div class="form-group">
        <label for="produto-fornecedor">Fornecedor *</label>
        <input type="text" id="produto-fornecedor" placeholder="Nome do fornecedor" required>
      </div>
      <div class="form-group">
        <label for="produto-codigo-barra">C√≥digo de Barras (EAN-13)</label>
        <input type="text" id="produto-codigo-barra" placeholder="7891234567890 (opcional)">
      </div>
      <div class="form-group">
        <label for="produto-descricao">Nome do Produto *</label>
        <input type="text" id="produto-descricao" placeholder="Ex: Bot√£o de Madeira" required>
      </div>
      <div class="form-group">
        <label for="produto-quantidade">Quantidade em Estoque *</label>
        <input type="number" id="produto-quantidade" min="0" value="0" required>
      </div>
      <div class="form-group">
        <label for="produto-preco-custo">Pre√ßo de Custo (R$) *</label>
        <input type="number" id="produto-preco-custo" step="0.01" min="0.01" placeholder="Ex: 3.50" required>
      </div>
      <div class="form-group">
        <label for="produto-preco-venda">Pre√ßo de Venda (R$) *</label>
        <input type="number" id="produto-preco-venda" step="0.01" min="0.01" placeholder="Ex: 5.00" required>
      </div>
    </div>
    
    <div class="modal-buttons">
      <button class="btn btn-danger" id="btn-fechar-produtos" style="flex:1; background:#95a5a6; color:white">Fechar</button>
      <button class="btn btn-primary" id="btn-salvar-produto" style="flex:1">üíæ Salvar Produto</button>
    </div>
  </div>
</div>

<!-- Modal Estoque (Admin) -->
<div class="modal" id="modal-estoque">
  <div class="modal-content">
    <h3>üì¶ Controle de Estoque</h3>
    <div class="form-group">
      <input type="text" id="busca-estoque" placeholder="Buscar produto no estoque..." style="margin-bottom:15px;">
    </div>
    <div style="display: flex; justify-content: space-between; padding:10px; background:#f8f9fa; border-radius:8px; margin-bottom:15px; font-weight:bold;">
      <div style="flex:3;">Produto</div>
      <div style="flex:1; text-align:center;">Estoque</div>
      <div style="flex:1; text-align:center;">A√ß√µes</div>
    </div>
    <div class="stock-list" id="lista-estoque">
      <!-- Lista de estoque ser√° carregada aqui -->
    </div>
    <div class="modal-buttons">
      <button class="btn" id="btn-fechar-estoque" style="flex:1; background:#95a5a6; color:white">Fechar</button>
    </div>
  </div>
</div>

<!-- Modal Selecionar Cliente -->
<div class="modal" id="modal-selecionar-cliente">
  <div class="modal-content">
    <h3>üë• Selecionar Cliente</h3>
    <input type="text" id="busca-cliente-modal" placeholder="Buscar por nome ou documento...">
    <div class="client-list" id="lista-clientes-modal">
      <!-- Clientes carregados aqui -->
    </div>
    <div class="modal-buttons">
      <button class="btn" id="btn-remover-cliente" style="flex:1; background:#95a5a6; color:white">Remover Cliente</button>
      <button class="btn" id="btn-fechar-cliente" style="flex:1; background:#7f8c8d; color:white">Fechar</button>
    </div>
  </div>
</div>

<!-- Modal Sangria -->
<div class="modal" id="modal-sangria">
  <div class="modal-content">
    <h3>üí∞ Sangria de Caixa</h3>
    <div class="form-group">
      <label for="valor-sangria">Valor da Sangria (R$)</label>
      <input type="number" id="valor-sangria" step="0.01" min="0.01" placeholder="Ex: 50.00">
    </div>
    <div class="form-group">
      <label for="especificacao-sangria">Especifica√ß√£o (opcional)</label>
      <input type="text" id="especificacao-sangria" placeholder="Motivo da sangria">
    </div>
    <div class="form-group">
      <label for="senha-admin-sangria">Senha de Administrador</label>
      <input type="password" id="senha-admin-sangria" placeholder="Digite a senha de administrador">
    </div>
    <div class="modal-buttons">
      <button class="btn" id="btn-cancelar-sangria" style="flex:1; background:#95a5a6; color:white">Cancelar</button>
      <button class="btn btn-danger" id="btn-confirmar-sangria" style="flex:1">Confirmar Sangria</button>
    </div>
  </div>
</div>

<!-- Modal Cupom -->
<div class="modal" id="modal-cupom">
  <div class="modal-content" style="max-width: 600px;">
    <h3>üìÑ Cupom Fiscal</h3>
    <div id="cupom-container" style="background:white; padding:20px; border:1px dashed #ddd; margin-bottom:20px;">
      <!-- Cupom ser√° gerado aqui -->
    </div>
    <div class="modal-buttons">
      <button class="btn" id="btn-fechar-cupom" style="flex:1; background:#95a5a6; color:white">Fechar</button>
      <button class="btn btn-primary" id="btn-imprimir-cupom" style="flex:1">üñ®Ô∏è Imprimir</button>
    </div>
  </div>
</div>

<!-- Notifications -->
<div id="notification-container" style="position:fixed; top:20px; right:20px; z-index:9999;"></div>

<script>
// ========== DADOS INICIAIS ==========
function inicializarDados() {
  if (!localStorage.getItem('vendas_db')) {
    const dbInicial = {
      usuarios: [
        { id: 1, nome: 'Administrador', login: 'admin', senha: 'java1814', perfil: 'admin' },
        { id: 2, nome: 'Operador', login: 'operador', senha: 'operador123', perfil: 'operador' }
        { id: 3, nome: 'Operador', login: 'beatriz', senha: 'bea123', perfil: 'operador' }
        { id: 2, nome: 'Operador', login: 'jarliane', senha: 'jarli987', perfil: 'operador' }
      ],
      produtos: [
     // === BEBIDAS ===
        { id: 1, fornecedor: 'Destilaria Caranguejo', codigo_barra: '', descricao: 'Cacha√ßa Caranguejo Prata 1L', quantidade: 20, preco_custo: 10.00, preco_venda: 14.00, ativo: true },
        { id: 2, fornecedor: 'Destilaria Caranguejo', codigo_barra: '', descricao: 'Cacha√ßa Caranguejo Lim√£o 1L', quantidade: 15, preco_custo: 13.00, preco_venda: 18.00, ativo: true },
        { id: 3, fornecedor: 'Pitu', codigo_barra: '', descricao: 'Lat√£o Pitu', quantidade: 30, preco_custo: 6.50, preco_venda: 9.00, ativo: true },
        { id: 4, fornecedor: 'Del Valle', codigo_barra: '', descricao: 'Suco de Uva Del Valle', quantidade: 25, preco_custo: 6.50, preco_venda: 9.00, ativo: true },
        { id: 5, fornecedor: 'Ypioca', codigo_barra: '', descricao: 'Ypioca Lata', quantidade: 40, preco_custo: 5.00, preco_venda: 7.00, ativo: true },
        { id: 6, fornecedor: '51', codigo_barra: '', descricao: '51 Lata', quantidade: 40, preco_custo: 5.00, preco_venda: 7.00, ativo: true },
        { id: 7, fornecedor: 'Mans√£o', codigo_barra: '', descricao: 'Mans√£o Maromba', quantidade: 12, preco_custo: 16.00, preco_venda: 22.00, ativo: true },
        { id: 8, fornecedor: 'Pitu', codigo_barra: '', descricao: 'Dose Pitu', quantidade: 50, preco_custo: 1.20, preco_venda: 2.00, ativo: true },
        { id: 9, fornecedor: 'Dreher', codigo_barra: '', descricao: 'Dose Dreher', quantidade: 40, preco_custo: 2.00, preco_venda: 3.00, ativo: true },
        { id: 10, fornecedor: 'Caranguejo', codigo_barra: '', descricao: 'Dose Caranguejo', quantidade: 50, preco_custo: 1.20, preco_venda: 2.00, ativo: true },
        { id: 11, fornecedor: 'Coca-Cola', codigo_barra: '', descricao: 'Coca Cola Lata', quantidade: 60, preco_custo: 3.50, preco_venda: 5.00, ativo: true },
        
        // === DOCES E SALGADINHOS ===
        { id: 12, fornecedor: 'Halls', codigo_barra: '', descricao: 'Pastilha Halls', quantidade: 30, preco_custo: 2.00, preco_venda: 3.00, ativo: true },
        { id: 13, fornecedor: 'Freegels', codigo_barra: '', descricao: 'Pastilha Freegels', quantidade: 25, preco_custo: 1.70, preco_venda: 2.50, ativo: true },
        { id: 14, fornecedor: 'Kro', codigo_barra: '', descricao: 'Pipoca Kro', quantidade: 35, preco_custo: 2.20, preco_venda: 3.00, ativo: true },
        { id: 15, fornecedor: 'Pepsi', codigo_barra: '', descricao: 'Pipos', quantidade: 45, preco_custo: 3.50, preco_venda: 5.00, ativo: true },
        { id: 16, fornecedor: 'V√°rios', codigo_barra: '', descricao: 'Biscoitos Recheado', quantidade: 40, preco_custo: 2.20, preco_venda: 3.00, ativo: true },
        { id: 17, fornecedor: 'Fruit Tella', codigo_barra: '', descricao: 'Fruit Tella', quantidade: 30, preco_custo: 1.80, preco_venda: 2.50, ativo: true },
        { id: 18, fornecedor: 'Kisuk', codigo_barra: '', descricao: 'Kisuk', quantidade: 50, preco_custo: 1.00, preco_venda: 1.50, ativo: true },
        
        // === MIOJOS ===
        { id: 19, fornecedor: 'Nissin', codigo_barra: '', descricao: 'Miojo Nissin Carne', quantidade: 40, preco_custo: 2.20, preco_venda: 3.00, ativo: true },
        { id: 20, fornecedor: 'Nissin', codigo_barra: '', descricao: 'Miojo Nissin Galinha', quantidade: 35, preco_custo: 2.60, preco_venda: 3.50, ativo: true },
        { id: 21, fornecedor: 'Nissin', codigo_barra: '', descricao: 'Cup Noodles', quantidade: 25, preco_custo: 6.00, preco_venda: 8.00, ativo: true },
        
        // === MERCADINHO ===
        { id: 22, fornecedor: 'Santa Clara', codigo_barra: '', descricao: 'Caf√© Santa Clara', quantidade: 20, preco_custo: 14.00, preco_venda: 18.00, ativo: true },
        { id: 23, fornecedor: 'V√°rios', codigo_barra: '', descricao: '√ìleo', quantidade: 30, preco_custo: 7.50, preco_venda: 10.00, ativo: true },
        { id: 24, fornecedor: 'V√°rios', codigo_barra: '', descricao: 'Sal', quantidade: 50, preco_custo: 1.30, preco_venda: 2.00, ativo: true },
        { id: 25, fornecedor: 'V√°rios', codigo_barra: '', descricao: 'A√ß√∫car', quantidade: 40, preco_custo: 3.80, preco_venda: 5.00, ativo: true },
        { id: 26, fornecedor: 'Nestl√©', codigo_barra: '', descricao: 'Kitut', quantidade: 25, preco_custo: 9.00, preco_venda: 12.00, ativo: true },
        { id: 27, fornecedor: 'Saz√≥n', codigo_barra: '', descricao: 'Saz√≥n unidade', quantidade: 100, preco_custo: 0.30, preco_venda: 0.50, ativo: true },
        { id: 28, fornecedor: 'V√°rios', codigo_barra: '', descricao: 'Margarina', quantidade: 35, preco_custo: 3.80, preco_venda: 5.00, ativo: true },
        { id: 29, fornecedor: 'V√°rios', codigo_barra: '', descricao: 'Creme de Leite', quantidade: 30, preco_custo: 2.20, preco_venda: 3.00, ativo: true },
        { id: 30, fornecedor: 'V√°rios', codigo_barra: '', descricao: 'Leite Condensado', quantidade: 35, preco_custo: 3.80, preco_venda: 5.00, ativo: true },
        { id: 31, fornecedor: 'V√°rios', codigo_barra: '', descricao: 'Macarr√£o Espaguete', quantidade: 40, preco_custo: 3.20, preco_venda: 4.50, ativo: true },
        { id: 32, fornecedor: 'V√°rios', codigo_barra: '', descricao: 'Coloral', quantidade: 30, preco_custo: 2.20, preco_venda: 3.00, ativo: true },
        { id: 33, fornecedor: 'Nestl√©', codigo_barra: '', descricao: 'Dueto', quantidade: 25, preco_custo: 3.80, preco_venda: 5.00, ativo: true },
        { id: 34, fornecedor: 'V√°rios', codigo_barra: '', descricao: 'Molho de Tomate', quantidade: 35, preco_custo: 1.80, preco_venda: 2.50, ativo: true },
        { id: 35, fornecedor: 'Quero', codigo_barra: '', descricao: 'Maionese Quero', quantidade: 30, preco_custo: 3.20, preco_venda: 4.50, ativo: true }
      ],
      clientes: [
        { id: 1, nome: 'CLIENTE', tipo: 'cpf', documento: '12345678901', whatsapp: '84999999999', telefone: '8433333333', email: 'maria@email.com', endereco: 'Rua A, 123', ativo: true },
        { id: 2, nome: 'CLIENTE1', tipo: 'cpf', documento: '98765432109', whatsapp: '84888888888', telefone: '8444444444', email: 'joao@email.com', endereco: 'Rua B, 456', ativo: true },
        { id: 3, nome: 'CLIENTEPJ', tipo: 'cnpj', documento: '12345678000190', whatsapp: '84777777777', telefone: '8433333333', email: 'contato@confeccao.com.br', endereco: 'Av. Industrial, 789', ativo: true }
      ],
      vendas: [],
      movimentacoes: [],
      config: {
        ultimoIdProduto: 8,
        ultimoIdCliente: 3,
        ultimoIdVenda: 0,
        nomeEmpresa: 'Armarinho do Z√©',
        cnpjEmpresa: '12.345.678/0001-90',
        enderecoEmpresa: 'Rua das Flores, 123 - Centro',
        telefoneEmpresa: '(84) 3333-4444'
      }
    };
    localStorage.setItem('vendas_db', JSON.stringify(dbInicial));
  }
  
  // Inicializar backups
  if (!localStorage.getItem('backups')) {
    localStorage.setItem('backups', JSON.stringify([]));
  }
}

// ========== FUN√á√ïES AUXILIARES ==========
function formatarMoeda(valor) {
  return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
}

function formatarDocumento(doc, tipo) {
  doc = doc.replace(/\D/g, '');
  if (tipo === 'cpf' && doc.length === 11) {
    return doc.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
  } else if (tipo === 'cnpj' && doc.length === 14) {
    return doc.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
  }
  return doc;
}

function formatarTelefone(tel) {
  tel = tel.replace(/\D/g, '');
  if (tel.length === 11) {
    return tel.replace(/(\d{2})(\d{1})(\d{4})(\d{4})/, '($1) $2.$3-$4');
  } else if (tel.length === 10) {
    return tel.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
  }
  return tel;
}

function buscarDados() {
  return JSON.parse(localStorage.getItem('vendas_db'));
}

function salvarDados(db) {
  localStorage.setItem('vendas_db', JSON.stringify(db));
}

function mostrarNotificacao(mensagem, tipo = 'success') {
  const container = document.getElementById('notification-container');
  const notificacao = document.createElement('div');
  notificacao.className = `notification ${tipo}`;
  notificacao.innerHTML = `<i>${tipo === 'success' ? '‚úÖ' : tipo === 'error' ? '‚ùå' : '‚ö†Ô∏è'}</i> <span>${mensagem}</span>`;
  container.appendChild(notificacao);
  setTimeout(() => {
    notificacao.remove();
  }, 3000);
}

// ========== LOGIN ==========
document.getElementById('btn-login').addEventListener('click', () => {
  const usuario = document.getElementById('login-user').value;
  const senha = document.getElementById('login-pass').value;
  const errorDiv = document.getElementById('error-login');
  
  if (!usuario) {
    errorDiv.textContent = '‚ö†Ô∏è Selecione um usu√°rio!';
    errorDiv.style.display = 'block';
    return;
  }
  
  if (!senha) {
    errorDiv.textContent = '‚ö†Ô∏è Digite a senha!';
    errorDiv.style.display = 'block';
    return;
  }
  
  const db = buscarDados();
  const user = db.usuarios.find(u => u.login === usuario && u.senha === senha);
  
  if (user) {
    sessionStorage.setItem('user_id', user.id);
    sessionStorage.setItem('user_perfil', user.perfil);
    sessionStorage.setItem('user_nome', user.nome);
    document.getElementById('user-name').textContent = user.nome;
    document.getElementById('screen-login').style.display = 'none';
    document.getElementById('screen-vendas').style.display = 'block';
    
    // Mostrar bot√£o de estoque s√≥ para admin
    if (user.perfil === 'admin') {
      document.getElementById('btn-estoque').style.display = 'block';
    }
    
    carregarProdutos();
    carregarClientes();
    errorDiv.style.display = 'none';
  } else {
    errorDiv.textContent = '‚ùå Senha incorreta!';
    errorDiv.style.display = 'block';
  }
});

document.getElementById('login-pass').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') document.getElementById('btn-login').click();
});

document.getElementById('login-user').addEventListener('change', () => {
  document.getElementById('login-pass').focus();
});

document.getElementById('btn-logout').addEventListener('click', () => {
  sessionStorage.clear();
  document.getElementById('screen-vendas').style.display = 'none';
  document.getElementById('screen-login').style.display = 'block';
  document.getElementById('login-user').value = '';
  document.getElementById('login-pass').value = '';
  document.getElementById('error-login').style.display = 'none';
  limparCarrinho();
});

// ========== PRODUTOS ==========
function carregarProdutos() {
  const db = buscarDados();
  const lista = document.getElementById('lista-produtos');
  lista.innerHTML = '';
  
  db.produtos.filter(p => p.ativo !== false && p.quantidade > 0).forEach(p => {
    const div = document.createElement('div');
    div.className = 'product-item';
    div.innerHTML = `<div class="name">${p.descricao}</div><div class="price">${formatarMoeda(p.preco_venda)} <small style="color:#7f8c8d;">(${p.quantidade} unid)</small></div>`;
    div.addEventListener('click', () => adicionarAoCarrinho(p));
    lista.appendChild(div);
  });
  
  // Busca por teclado
  document.getElementById('busca-produto').addEventListener('input', (e) => {
    const termo = e.target.value.toLowerCase();
    lista.innerHTML = '';
    db.produtos.filter(p => p.ativo !== false && p.quantidade > 0 && p.descricao.toLowerCase().includes(termo)).forEach(p => {
      const div = document.createElement('div');
      div.className = 'product-item';
      div.innerHTML = `<div class="name">${p.descricao}</div><div class="price">${formatarMoeda(p.preco_venda)} <small style="color:#7f8c8d;">(${p.quantidade} unid)</small></div>`;
      div.addEventListener('click', () => adicionarAoCarrinho(p));
      lista.appendChild(div);
    });
  });
}

// ========== CLIENTES ==========
function carregarClientes() {
  const db = buscarDados();
  
  // Modal Selecionar Cliente
  const listaModal = document.getElementById('lista-clientes-modal');
  listaModal.innerHTML = '';
  db.clientes.filter(c => c.ativo !== false).forEach(c => {
    const div = document.createElement('div');
    div.className = 'client-item';
    div.innerHTML = `
      <div class="name">${c.nome}</div>
      <div class="doc">
        <span class="badge badge-${c.tipo}">${c.tipo.toUpperCase()}</span> 
        ${formatarDocumento(c.documento, c.tipo)} | 
        <span style="color:#25D366;">${formatarTelefone(c.whatsapp)}</span>
      </div>
    `;
    div.addEventListener('click', () => selecionarCliente(c));
    listaModal.appendChild(div);
  });
  
  // Modal Clientes - Lista
  const listaClientes = document.getElementById('container-clientes-lista');
  listaClientes.innerHTML = '';
  db.clientes.filter(c => c.ativo !== false).forEach(c => {
    const div = document.createElement('div');
    div.style.padding = '10px';
    div.style.borderBottom = '1px solid #eee';
    div.innerHTML = `
      <div style="font-weight:500">${c.nome}</div>
      <div style="font-size:12px; color:#7f8c8d;">
        <span class="badge badge-${c.tipo}">${c.tipo.toUpperCase()}</span> 
        ${formatarDocumento(c.documento, c.tipo)} | 
        <span style="color:#25D366;">${formatarTelefone(c.whatsapp)}</span>
        ${c.email ? ` | ${c.email}` : ''}
      </div>
    `;
    listaClientes.appendChild(div);
  });
}

function selecionarCliente(cliente) {
  clienteSelecionado = cliente;
  document.getElementById('cliente-selecionado').innerHTML = `
    <div class="client-selected">
      <div class="name">${cliente.nome}</div>
      <div class="doc">
        <span class="badge badge-${cliente.tipo}">${cliente.tipo.toUpperCase()}</span> 
        ${formatarDocumento(cliente.documento, cliente.tipo)} | 
        <span style="color:#25D366;">${formatarTelefone(cliente.whatsapp)}</span>
      </div>
    </div>
  `;
  fecharModal('modal-selecionar-cliente');
}

// ========== CARRINHO ==========
let carrinho = [];
let clienteSelecionado = null;
let formaPagamento = 'pix';

function atualizarCarrinho() {
  const container = document.getElementById('itens-carrinho');
  const countEl = document.getElementById('cart-count');
  const subtotalEl = document.getElementById('subtotal');
  const totalEl = document.getElementById('total');
  const formaEl = document.getElementById('forma-pagamento');
  
  if (carrinho.length === 0) {
    container.innerHTML = '<div class="empty-cart">Carrinho vazio. Adicione produtos para iniciar a venda.</div>';
    countEl.textContent = '0 itens';
    subtotalEl.textContent = 'R$ 0,00';
    totalEl.textContent = 'R$ 0,00';
    formaEl.textContent = 'Pix';
    return;
  }
  
  let html = '';
  let subtotal = 0;
  carrinho.forEach(item => {
    const totalItem = item.quantidade * item.preco_venda;
    subtotal += totalItem;
    html += `
      <div class="cart-item">
        <div class="desc">${item.descricao}</div>
        <div class="qty">${item.quantidade}x</div>
        <div class="price">${formatarMoeda(item.preco_venda)}</div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  countEl.textContent = `${carrinho.length} itens`;
  subtotalEl.textContent = formatarMoeda(subtotal);
  totalEl.textContent = formatarMoeda(subtotal);
  
  // Atualizar forma de pagamento
  const formas = {
    pix: 'Pix',
    credit: 'Cart√£o de Cr√©dito',
    debit: 'Cart√£o de D√©bito',
    money: 'Dinheiro'
  };
  formaEl.textContent = formas[formaPagamento] || 'Pix';
  
  // Atualizar c√°lculo de troco se for dinheiro
  atualizarTroco();
}

function adicionarAoCarrinho(produto) {
  // Verificar estoque
  if (produto.quantidade <= 0) {
    mostrarNotificacao('‚ö†Ô∏è Produto sem estoque!', 'error');
    return;
  }
  
  const existente = carrinho.find(i => i.produto_id === produto.id);
  if (existente) {
    // Verificar se h√° estoque suficiente
    if (existente.quantidade >= produto.quantidade) {
      mostrarNotificacao(`‚ö†Ô∏è Estoque insuficiente! M√°ximo: ${produto.quantidade}`, 'error');
      return;
    }
    existente.quantidade += 1;
  } else {
    carrinho.push({
      produto_id: produto.id,
      descricao: produto.descricao,
      quantidade: 1,
      preco_custo: produto.preco_custo,
      preco_venda: produto.preco_venda,
      fornecedor: produto.fornecedor
    });
  }
  atualizarCarrinho();
  mostrarNotificacao(`‚úÖ ${produto.descricao} adicionado!`, 'success');
  document.getElementById('busca-produto').value = '';
  document.getElementById('barcode-input').value = '';
}

function limparCarrinho() {
  carrinho = [];
  clienteSelecionado = null;
  document.getElementById('cliente-selecionado').innerHTML = '<div style="color: #7f8c8d; font-style: italic;">Nenhum cliente selecionado</div>';
  atualizarCarrinho();
}

// ========== FORMAS DE PAGAMENTO ==========
document.querySelectorAll('.payment-option').forEach(option => {
  option.addEventListener('click', () => {
    document.querySelectorAll('.payment-option').forEach(o => o.classList.remove('selected'));
    option.classList.add('selected');
    formaPagamento = option.getAttribute('data-payment');
    
    // Mostrar/ocultar campo de valor recebido
    const moneyInput = document.getElementById('payment-money-input');
    const trocoRow = document.getElementById('troco-row');
    if (formaPagamento === 'money') {
      moneyInput.classList.add('active');
      trocoRow.style.display = 'flex';
    } else {
      moneyInput.classList.remove('active');
      trocoRow.style.display = 'none';
      document.getElementById('valor-recebido').value = '';
    }
    atualizarCarrinho();
  });
});

function atualizarTroco() {
  if (formaPagamento !== 'money') return;
  
  const valorRecebido = parseFloat(document.getElementById('valor-recebido').value) || 0;
  const total = carrinho.reduce((sum, item) => sum + (item.quantidade * item.preco_venda), 0);
  const troco = valorRecebido - total;
  
  document.getElementById('troco-valor').textContent = formatarMoeda(troco);
}

document.getElementById('valor-recebido').addEventListener('input', atualizarTroco);

// ========== LEITOR DE C√ìDIGO DE BARRAS ==========
document.getElementById('barcode-input').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    const codigo = document.getElementById('barcode-input').value.trim();
    if (codigo) {
      const db = buscarDados();
      const produto = db.produtos.find(p => 
        (p.codigo_barra && p.codigo_barra === codigo) || 
        (p.descricao.toLowerCase().includes(codigo.toLowerCase()))
      );
      
      if (produto && produto.ativo !== false && produto.quantidade > 0) {
        adicionarAoCarrinho(produto);
      } else {
        mostrarNotificacao('‚ùå Produto n√£o encontrado ou sem estoque!', 'error');
      }
      
      document.getElementById('barcode-input').value = '';
    }
  }
});

// ========== SCANNER DE C√ÇMERA ==========
let html5QrcodeScanner = null;

function abrirScanner() {
  document.getElementById('scanner-modal').classList.add('active');
  
  html5QrcodeScanner = new Html5Qrcode("reader");
  
  html5QrcodeScanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: { width: 250, height: 250 } },
    (decodedText) => {
      html5QrcodeScanner.stop().then(() => {
        document.getElementById('scanner-modal').classList.remove('active');
        
        const db = buscarDados();
        const produto = db.produtos.find(p => 
          (p.codigo_barra && p.codigo_barra === decodedText.trim()) || 
          (p.descricao.toLowerCase().includes(decodedText.trim().toLowerCase()))
        );
        
        if (produto && produto.ativo !== false && produto.quantidade > 0) {
          adicionarAoCarrinho(produto);
          mostrarNotificacao(`‚úÖ ${produto.descricao} adicionado!`, 'success');
        } else {
          mostrarNotificacao('‚ùå Produto n√£o encontrado ou sem estoque!', 'error');
        }
      }).catch(err => console.error("Erro ao parar scanner:", err));
    },
    (err) => {}
  ).catch(err => {
    console.error("Erro ao iniciar scanner:", err);
    mostrarNotificacao('‚ùå Erro ao acessar c√¢mera!', 'error');
    document.getElementById('scanner-modal').classList.remove('active');
  });
}

function fecharScanner() {
  if (html5QrcodeScanner) {
    html5QrcodeScanner.stop().then(() => {
      document.getElementById('scanner-modal').classList.remove('active');
    }).catch(err => console.error("Erro ao parar scanner:", err));
  }
}

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') fecharScanner();
});

// ========== BACKUP ==========
document.getElementById('btn-backup').addEventListener('click', () => {
  document.getElementById('modal-backup').style.display = 'flex';
  atualizarListaBackups();
});

document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('tab-' + tab.getAttribute('data-tab')).classList.add('active');
  });
});

document.getElementById('btn-criar-backup').addEventListener('click', () => {
  const db = buscarDados();
  const backup = {
    data: new Date().toISOString(),
    dados: JSON.parse(JSON.stringify(db))
  };
  
  const backups = JSON.parse(localStorage.getItem('backups')) || [];
  backups.push(backup);
  localStorage.setItem('backups', JSON.stringify(backups));
  
  mostrarNotificacao('‚úÖ Backup criado com sucesso!', 'success');
  atualizarListaBackups();
});

document.getElementById('btn-download-backup').addEventListener('click', () => {
  const db = buscarDados();
  const backup = {
    data: new Date().toISOString(),
    sistema: 'Sistema de Vendas - Armarinho',
    dados: db
  };
  
  const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `backup-armarinho-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  
  mostrarNotificacao('‚úÖ Backup baixado com sucesso!', 'success');
});

function atualizarListaBackups() {
  const lista = document.getElementById('lista-backups');
  const vazio = document.getElementById('backup-vazio');
  const backups = JSON.parse(localStorage.getItem('backups')) || [];
  
  if (backups.length === 0) {
    vazio.style.display = 'block';
    lista.innerHTML = '';
    return;
  }
  
  vazio.style.display = 'none';
  lista.innerHTML = '';
  
  backups.reverse().forEach((backup, index) => {
    const data = new Date(backup.data);
    const div = document.createElement('div');
    div.style.padding = '12px';
    div.style.borderBottom = '1px solid #eee';
    div.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <div style="font-weight:500;">Backup ${backups.length - index}</div>
          <div style="font-size:12px; color:#7f8c8d;">${data.toLocaleDateString('pt-BR')} √†s ${data.toLocaleTimeString('pt-BR')}</div>
        </div>
        <div style="display:flex; gap:8px;">
          <button class="btn btn-sm" style="background:#3498db; color:white; padding:6px 10px;" onclick="restaurarBackup(${backups.length - 1 - index})">üîÑ Restaurar</button>
          <button class="btn btn-sm" style="background:#e74c3c; color:white; padding:6px 10px;" onclick="deletarBackup(${backups.length - 1 - index})">üóëÔ∏è Deletar</button>
        </div>
      </div>
    `;
    lista.appendChild(div);
  });
}

function restaurarBackup(index) {
  if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Restaurar este backup substituir√° todos os dados atuais. Deseja continuar?')) return;
  
  const backups = JSON.parse(localStorage.getItem('backups')) || [];
  const backup = backups[index];
  
  if (backup && backup.dados) {
    localStorage.setItem('vendas_db', JSON.stringify(backup.dados));
    mostrarNotificacao('‚úÖ Backup restaurado com sucesso!', 'success');
    location.reload();
  }
}

function deletarBackup(index) {
  if (!confirm('Deseja deletar este backup?')) return;
  
  const backups = JSON.parse(localStorage.getItem('backups')) || [];
  backups.splice(index, 1);
  localStorage.setItem('backups', JSON.stringify(backups));
  
  mostrarNotificacao('üóëÔ∏è Backup deletado!', 'success');
  atualizarListaBackups();
}

document.getElementById('btn-fechar-backup').addEventListener('click', () => {
  document.getElementById('modal-backup').style.display = 'none';
});

// ========== LEITURA Z ==========
document.getElementById('btn-leitura-z').addEventListener('click', () => {
  document.getElementById('modal-leitura-z').style.display = 'flex';
  
  const hoje = new Date();
  const ontem = new Date();
  ontem.setDate(ontem.getDate() - 1);
  
  document.getElementById('data-inicio-zreport').valueAsDate = ontem;
  document.getElementById('data-fim-zreport').valueAsDate = hoje;
});

document.getElementById('btn-gerar-zreport').addEventListener('click', () => {
  const dataInicio = new Date(document.getElementById('data-inicio-zreport').value);
  const dataFim = new Date(document.getElementById('data-fim-zreport').value);
  dataFim.setHours(23, 59, 59, 999);
  
  const db = buscarDados();
  const vendasPeriodo = db.vendas.filter(v => {
    const dataVenda = new Date(v.data);
    return dataVenda >= dataInicio && dataVenda <= dataFim;
  });
  
  let totalVendas = 0;
  let totalItens = 0;
  
  vendasPeriodo.forEach(v => {
    totalVendas += v.total;
    totalItens += v.itens.reduce((sum, item) => sum + item.quantidade, 0);
  });
  
  document.getElementById('zreport-content').innerHTML = `
    <div style="font-size:14px;">
      <div style="margin-bottom:15px;">
        <strong>Per√≠odo:</strong> ${dataInicio.toLocaleDateString('pt-BR')} a ${dataFim.toLocaleDateString('pt-BR')}
      </div>
      <div style="margin-bottom:10px;">
        <strong>Total de Vendas:</strong> ${formatarMoeda(totalVendas)}
      </div>
      <div style="margin-bottom:10px;">
        <strong>N√∫mero de Vendas:</strong> ${vendasPeriodo.length}
      </div>
      <div style="margin-bottom:10px;">
        <strong>Total de Itens Vendidos:</strong> ${totalItens}
      </div>
      <div style="margin-top:20px; padding-top:15px; border-top:2px solid #2c3e5e;">
        <strong style="font-size:16px; color:#2c3e5e;">Relat√≥rio de Vendas</strong>
      </div>
      ${vendasPeriodo.length > 0 ? `
        <div style="margin-top:10px; max-height:300px; overflow-y:auto;">
          ${vendasPeriodo.map(v => `
            <div style="margin-bottom:10px; padding:10px; background:#f8f9fa; border-radius:5px;">
              <div><strong>Cupom #${v.id}</strong> - ${new Date(v.data).toLocaleString('pt-BR')}</div>
              <div>Total: ${formatarMoeda(v.total)}</div>
              <div>Itens: ${v.itens.length}</div>
              <div>Cliente: ${v.cliente_id ? db.clientes.find(c => c.id === v.cliente_id)?.nome || 'N√£o informado' : 'N√£o informado'}</div>
            </div>
          `).join('')}
        </div>
      ` : '<div style="margin-top:10px; color:#7f8c8d;">Nenhuma venda encontrada no per√≠odo.</div>'}
    </div>
  `;
  
  document.getElementById('zreport-container').style.display = 'block';
});

document.getElementById('btn-fechar-zreport').addEventListener('click', () => {
  document.getElementById('modal-leitura-z').style.display = 'none';
  document.getElementById('zreport-container').style.display = 'none';
});

// ========== MODAL CLIENTES ==========
document.getElementById('btn-clientes-menu').addEventListener('click', () => {
  document.getElementById('modal-clientes').style.display = 'flex';
  carregarClientes();
});

document.getElementById('btn-selecionar-cliente').addEventListener('click', () => {
  document.getElementById('modal-selecionar-cliente').style.display = 'flex';
  carregarClientes();
});

document.getElementById('btn-fechar-cliente').addEventListener('click', () => {
  document.getElementById('modal-selecionar-cliente').style.display = 'none';
});

document.getElementById('btn-remover-cliente').addEventListener('click', () => {
  clienteSelecionado = null;
  document.getElementById('cliente-selecionado').innerHTML = '<div style="color: #7f8c8d; font-style: italic;">Nenhum cliente selecionado</div>';
  document.getElementById('modal-selecionar-cliente').style.display = 'none';
});

document.getElementById('btn-fechar-clientes').addEventListener('click', () => {
  document.getElementById('modal-clientes').style.display = 'none';
});

document.getElementById('btn-salvar-cliente').addEventListener('click', () => {
  const nome = document.getElementById('cliente-nome').value.trim();
  const tipo = document.getElementById('cliente-tipo').value;
  const documento = document.getElementById('cliente-documento').value.trim().replace(/\D/g, '');
  const whatsapp = document.getElementById('cliente-whatsapp').value.trim().replace(/\D/g, '');
  const telefone = document.getElementById('cliente-telefone').value.trim().replace(/\D/g, '');
  const email = document.getElementById('cliente-email').value.trim();
  const endereco = document.getElementById('cliente-endereco').value.trim();
  
  if (!nome || !documento || !whatsapp) {
    mostrarNotificacao('‚ö†Ô∏è Preencha nome, CPF/CNPJ e WhatsApp!', 'error');
    return;
  }
  
  // Validar CPF/CNPJ
  if ((tipo === 'cpf' && documento.length !== 11) || (tipo === 'cnpj' && documento.length !== 14)) {
    mostrarNotificacao(`‚ö†Ô∏è ${tipo.toUpperCase()} inv√°lido!`, 'error');
    return;
  }
  
  // Validar WhatsApp
  if (whatsapp.length < 10 || whatsapp.length > 11) {
    mostrarNotificacao('‚ö†Ô∏è WhatsApp inv√°lido!', 'error');
    return;
  }
  
  const db = buscarDados();
  db.config.ultimoIdCliente++;
  
  db.clientes.push({
    id: db.config.ultimoIdCliente,
    nome,
    tipo,
    documento,
    whatsapp,
    telefone: telefone || '',
    email: email || '',
    endereco: endereco || '',
    ativo: true
  });
  
  salvarDados(db);
  mostrarNotificacao('‚úÖ Cliente cadastrado com sucesso!', 'success');
  
  // Limpar formul√°rio
  document.getElementById('cliente-nome').value = '';
  document.getElementById('cliente-documento').value = '';
  document.getElementById('cliente-whatsapp').value = '';
  document.getElementById('cliente-telefone').value = '';
  document.getElementById('cliente-email').value = '';
  document.getElementById('cliente-endereco').value = '';
  
  carregarClientes();
});

// Busca de clientes
document.getElementById('busca-clientes-lista').addEventListener('input', (e) => {
  const termo = e.target.value.toLowerCase();
  const db = buscarDados();
  const lista = document.getElementById('container-clientes-lista');
  lista.innerHTML = '';
  
  db.clientes.filter(c => c.ativo !== false && 
    (c.nome.toLowerCase().includes(termo) || 
     c.documento.includes(termo.replace(/\D/g, '')) ||
     c.whatsapp.includes(termo.replace(/\D/g, ''))))
  .forEach(c => {
    const div = document.createElement('div');
    div.style.padding = '10px';
    div.style.borderBottom = '1px solid #eee';
    div.innerHTML = `
      <div style="font-weight:500">${c.nome}</div>
      <div style="font-size:12px; color:#7f8c8d;">
        <span class="badge badge-${c.tipo}">${c.tipo.toUpperCase()}</span> 
        ${formatarDocumento(c.documento, c.tipo)} | 
        <span style="color:#25D366;">${formatarTelefone(c.whatsapp)}</span>
        ${c.email ? ` | ${c.email}` : ''}
      </div>
    `;
    lista.appendChild(div);
  });
});

// ========== MODAL PRODUTOS ==========
document.getElementById('btn-produtos-menu').addEventListener('click', () => {
  document.getElementById('modal-produtos').style.display = 'flex';
  carregarListaProdutos();
});

document.getElementById('btn-fechar-produtos').addEventListener('click', () => {
  document.getElementById('modal-produtos').style.display = 'none';
});

document.getElementById('btn-salvar-produto').addEventListener('click', () => {
  const fornecedor = document.getElementById('produto-fornecedor').value.trim();
  const codigoBarra = document.getElementById('produto-codigo-barra').value.trim();
  const descricao = document.getElementById('produto-descricao').value.trim();
  const quantidade = parseInt(document.getElementById('produto-quantidade').value) || 0;
  const precoCusto = parseFloat(document.getElementById('produto-preco-custo').value);
  const precoVenda = parseFloat(document.getElementById('produto-preco-venda').value);
  
  if (!fornecedor || !descricao || isNaN(precoCusto) || isNaN(precoVenda)) {
    mostrarNotificacao('‚ö†Ô∏è Preencha fornecedor, produto, pre√ßo de custo e venda!', 'error');
    return;
  }
  
  if (precoCusto <= 0 || precoVenda <= 0) {
    mostrarNotificacao('‚ö†Ô∏è Pre√ßos devem ser maiores que zero!', 'error');
    return;
  }
  
  if (precoVenda < precoCusto) {
    mostrarNotificacao('‚ö†Ô∏è Pre√ßo de venda deve ser maior ou igual ao custo!', 'error');
    return;
  }
  
  const db = buscarDados();
  db.config.ultimoIdProduto++;
  
  db.produtos.push({
    id: db.config.ultimoIdProduto,
    fornecedor,
    codigo_barra: codigoBarra || '',
    descricao,
    quantidade,
    preco_custo: precoCusto,
    preco_venda: precoVenda,
    ativo: true
  });
  
  salvarDados(db);
  mostrarNotificacao('‚úÖ Produto cadastrado com sucesso!', 'success');
  
  // Limpar formul√°rio
  document.getElementById('produto-fornecedor').value = '';
  document.getElementById('produto-codigo-barra').value = '';
  document.getElementById('produto-descricao').value = '';
  document.getElementById('produto-quantidade').value = '0';
  document.getElementById('produto-preco-custo').value = '';
  document.getElementById('produto-preco-venda').value = '';
  
  carregarListaProdutos();
  carregarProdutos();
});

function carregarListaProdutos() {
  const db = buscarDados();
  const lista = document.getElementById('container-produtos-lista');
  lista.innerHTML = '';
  
  db.produtos.filter(p => p.ativo !== false).forEach(p => {
    const div = document.createElement('div');
    div.style.padding = '10px';
    div.style.borderBottom = '1px solid #eee';
    div.innerHTML = `
      <div style="font-weight:500">${p.descricao}</div>
      <div style="display:flex; justify-content:space-between; font-size:12px; color:#7f8c8d; margin-top:5px;">
        <span>Fornecedor: ${p.fornecedor}</span>
        <span>Custo: ${formatarMoeda(p.preco_custo)}</span>
        <span>Venda: ${formatarMoeda(p.preco_venda)}</span>
        <span>Estoque: ${p.quantidade}</span>
      </div>
      ${p.codigo_barra ? `<div style="font-size:11px; color:#95a5a6; margin-top:3px;">C√≥d. Barras: ${p.codigo_barra}</div>` : ''}
    `;
    lista.appendChild(div);
  });
}

// Busca de produtos
document.getElementById('busca-produtos-lista').addEventListener('input', (e) => {
  const termo = e.target.value.toLowerCase();
  const db = buscarDados();
  const lista = document.getElementById('container-produtos-lista');
  lista.innerHTML = '';
  
  db.produtos.filter(p => p.ativo !== false && 
    (p.descricao.toLowerCase().includes(termo) || 
     p.fornecedor.toLowerCase().includes(termo) ||
     p.codigo_barra.includes(termo)))
  .forEach(p => {
    const div = document.createElement('div');
    div.style.padding = '10px';
    div.style.borderBottom = '1px solid #eee';
    div.innerHTML = `
      <div style="font-weight:500">${p.descricao}</div>
      <div style="display:flex; justify-content:space-between; font-size:12px; color:#7f8c8d; margin-top:5px;">
        <span>Fornecedor: ${p.fornecedor}</span>
        <span>Custo: ${formatarMoeda(p.preco_custo)}</span>
        <span>Venda: ${formatarMoeda(p.preco_venda)}</span>
        <span>Estoque: ${p.quantidade}</span>
      </div>
      ${p.codigo_barra ? `<div style="font-size:11px; color:#95a5a6; margin-top:3px;">C√≥d. Barras: ${p.codigo_barra}</div>` : ''}
    `;
    lista.appendChild(div);
  });
});

// ========== ESTOQUE (ADMIN) ==========
document.getElementById('btn-estoque').addEventListener('click', () => {
  if (sessionStorage.getItem('user_perfil') !== 'admin') {
    mostrarNotificacao('‚ö†Ô∏è Acesso restrito a administrador!', 'error');
    return;
  }
  document.getElementById('modal-estoque').style.display = 'flex';
  carregarEstoque();
});

document.getElementById('btn-fechar-estoque').addEventListener('click', () => {
  document.getElementById('modal-estoque').style.display = 'none';
});

function carregarEstoque() {
  const db = buscarDados();
  const lista = document.getElementById('lista-estoque');
  lista.innerHTML = '';
  
  db.produtos.filter(p => p.ativo !== false).sort((a, b) => a.quantidade - b.quantidade).forEach(p => {
    // Determinar cor do badge baseado no estoque
    let badgeClass = 'badge-stock-high';
    if (p.quantidade <= 5) {
      badgeClass = 'badge-stock-low';
    } else if (p.quantidade <= 20) {
      badgeClass = 'badge-stock-medium';
    }
    
    const div = document.createElement('div');
    div.className = 'stock-item';
    div.innerHTML = `
      <div class="info">
        <div class="name">${p.descricao}</div>
        <div class="details">
          <span style="color:#7f8c8d;">${p.fornecedor}</span> | 
          Custo: ${formatarMoeda(p.preco_custo)} | 
          Venda: ${formatarMoeda(p.preco_venda)}
          ${p.codigo_barra ? ` | C√≥d: ${p.codigo_barra}` : ''}
        </div>
      </div>
      <div class="quantity">
        <span class="badge ${badgeClass}">${p.quantidade} unid</span>
      </div>
      <div class="actions">
        <button class="btn-sm edit" onclick="editarProduto(${p.id})">‚úèÔ∏è Editar</button>
      </div>
    `;
    lista.appendChild(div);
  });
}

// Busca no estoque
document.getElementById('busca-estoque').addEventListener('input', (e) => {
  const termo = e.target.value.toLowerCase();
  const db = buscarDados();
  const lista = document.getElementById('lista-estoque');
  lista.innerHTML = '';
  
  db.produtos.filter(p => p.ativo !== false && 
    (p.descricao.toLowerCase().includes(termo) || 
     p.fornecedor.toLowerCase().includes(termo) ||
     p.codigo_barra.includes(termo)))
  .sort((a, b) => a.quantidade - b.quantidade)
  .forEach(p => {
    let badgeClass = 'badge-stock-high';
    if (p.quantidade <= 5) {
      badgeClass = 'badge-stock-low';
    } else if (p.quantidade <= 20) {
      badgeClass = 'badge-stock-medium';
    }
    
    const div = document.createElement('div');
    div.className = 'stock-item';
    div.innerHTML = `
      <div class="info">
        <div class="name">${p.descricao}</div>
        <div class="details">
          <span style="color:#7f8c8d;">${p.fornecedor}</span> | 
          Custo: ${formatarMoeda(p.preco_custo)} | 
          Venda: ${formatarMoeda(p.preco_venda)}
          ${p.codigo_barra ? ` | C√≥d: ${p.codigo_barra}` : ''}
        </div>
      </div>
      <div class="quantity">
        <span class="badge ${badgeClass}">${p.quantidade} unid</span>
      </div>
      <div class="actions">
        <button class="btn-sm edit" onclick="editarProduto(${p.id})">‚úèÔ∏è Editar</button>
      </div>
    `;
    lista.appendChild(div);
  });
});

function editarProduto(id) {
  const db = buscarDados();
  const produto = db.produtos.find(p => p.id === id);
  
  if (!produto) return;
  
  const novaQuantidade = prompt(`Editar estoque de "${produto.descricao}"\nEstoque atual: ${produto.quantidade}\nDigite a nova quantidade:`, produto.quantidade);
  
  if (novaQuantidade !== null && !isNaN(novaQuantidade)) {
    const qtd = parseInt(novaQuantidade);
    if (qtd >= 0) {
      produto.quantidade = qtd;
      salvarDados(db);
      carregarEstoque();
      carregarProdutos();
      mostrarNotificacao('‚úÖ Estoque atualizado com sucesso!', 'success');
    } else {
      mostrarNotificacao('‚ö†Ô∏è Quantidade deve ser maior ou igual a zero!', 'error');
    }
  }
}

// ========== SANGRIA ==========
document.getElementById('btn-sangria').addEventListener('click', () => {
  document.getElementById('modal-sangria').style.display = 'flex';
});

document.getElementById('btn-cancelar-sangria').addEventListener('click', () => {
  document.getElementById('modal-sangria').style.display = 'none';
  document.getElementById('valor-sangria').value = '';
  document.getElementById('especificacao-sangria').value = '';
  document.getElementById('senha-admin-sangria').value = '';
});

document.getElementById('btn-confirmar-sangria').addEventListener('click', () => {
  const valor = parseFloat(document.getElementById('valor-sangria').value);
  const especificacao = document.getElementById('especificacao-sangria').value.trim();
  const senha = document.getElementById('senha-admin-sangria').value;
  
  if (isNaN(valor) || valor <= 0) {
    mostrarNotificacao('‚ö†Ô∏è Valor inv√°lido!', 'error');
    return;
  }
  
  if (senha !== 'java1814') {
    mostrarNotificacao('‚ùå Senha de administrador incorreta!', 'error');
    return;
  }
  
  const db = buscarDados();
  db.movimentacoes.push({
    tipo: 'sangria',
    valor: valor,
    especificacao: especificacao || 'Sangria de caixa',
    data: new Date().toISOString(),
    usuario_id: parseInt(sessionStorage.getItem('user_id'))
  });
  
  salvarDados(db);
  mostrarNotificacao(`‚úÖ Sangria de ${formatarMoeda(valor)} realizada!`, 'success');
  
  document.getElementById('modal-sangria').style.display = 'none';
  document.getElementById('valor-sangria').value = '';
  document.getElementById('especificacao-sangria').value = '';
  document.getElementById('senha-admin-sangria').value = '';
});

// ========== FINALIZAR VENDA ==========
document.getElementById('btn-cancelar').addEventListener('click', () => {
  if (carrinho.length > 0 && !confirm('Deseja cancelar esta venda?')) return;
  limparCarrinho();
  mostrarNotificacao('üõí Venda cancelada!', 'success');
});

document.getElementById('btn-finalizar').addEventListener('click', () => {
  if (carrinho.length === 0) {
    mostrarNotificacao('‚ö†Ô∏è Carrinho vazio!', 'error');
    return;
  }
  
  // Verificar estoque antes de finalizar
  const db = buscarDados();
  for (const item of carrinho) {
    const produto = db.produtos.find(p => p.id === item.produto_id);
    if (!produto || produto.quantidade < item.quantidade) {
      mostrarNotificacao(`‚ö†Ô∏è Estoque insuficiente para ${item.descricao}!`, 'error');
      return;
    }
  }
  
  const total = carrinho.reduce((sum, item) => sum + (item.quantidade * item.preco_venda), 0);
  
  // Gerar cupom
  const cupomHTML = `
    <div style="font-family: 'Courier New', monospace; font-size:12px;">
      <div style="text-align:center; border-bottom:2px dashed #000; padding-bottom:10px; margin-bottom:10px;">
        <div style="font-weight:bold; font-size:16px;">${db.config.nomeEmpresa}</div>
        <div style="font-size:11px;">${db.config.cnpjEmpresa}</div>
        <div style="font-size:10px;">${db.config.enderecoEmpresa}</div>
        <div style="font-size:10px;">${db.config.telefoneEmpresa}</div>
      </div>
      
      <div style="margin-bottom:10px;">
        <div><strong>Cupom:</strong> #${db.config.ultimoIdVenda + 1}</div>
        <div><strong>Data:</strong> ${new Date().toLocaleString('pt-BR')}</div>
        ${clienteSelecionado ? `
          <div style="margin-top:5px; padding:5px; background:#f0f0f0; border-radius:3px;">
            <div><strong>Cliente:</strong> ${clienteSelecionado.nome}</div>
            <div>
              <span class="badge badge-${clienteSelecionado.tipo}">${clienteSelecionado.tipo.toUpperCase()}</span> 
              ${formatarDocumento(clienteSelecionado.documento, clienteSelecionado.tipo)} | 
              <span style="color:#25D366;">${formatarTelefone(clienteSelecionado.whatsapp)}</span>
            </div>
          </div>
        ` : ''}
      </div>
      
      <div style="margin-bottom:10px;">
        ${carrinho.map(item => `
          <div style="display:flex; justify-content:space-between; margin-bottom:3px;">
            <span style="flex:2;">${item.descricao}</span>
            <span style="flex:1; text-align:right;">${item.quantidade}x</span>
            <span style="flex:1; text-align:right;">${formatarMoeda(item.preco_venda)}</span>
          </div>
        `).join('')}
      </div>
      
      <div style="border-top:2px solid #000; border-bottom:2px solid #000; padding:8px 0; margin-bottom:10px;">
        <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:14px;">
          <span>TOTAL:</span>
          <span>${formatarMoeda(total)}</span>
        </div>
        <div style="display:flex; justify-content:space-between; margin-top:5px; font-size:12px;">
          <span>Forma:</span>
          <span>${formaPagamento === 'pix' ? 'Pix' : formaPagamento === 'credit' ? 'Cart√£o Cr√©dito' : formaPagamento === 'debit' ? 'Cart√£o D√©bito' : 'Dinheiro'}</span>
        </div>
        ${formaPagamento === 'money' ? `
          <div style="display:flex; justify-content:space-between; margin-top:5px; font-size:12px; color:#2ecc71;">
            <span>Troco:</span>
            <span>${formatarMoeda(parseFloat(document.getElementById('valor-recebido').value || 0) - total)}</span>
          </div>
        ` : ''}
      </div>
      
      <div style="text-align:center; font-size:10px; color:#666;">
        <div>Obrigado pela prefer√™ncia!</div>
        <div>----------</div>
        <div>${new Date().toLocaleString('pt-BR')}</div>
      </div>
    </div>
  `;
  
  document.getElementById('cupom-container').innerHTML = cupomHTML;
  document.getElementById('modal-cupom').style.display = 'flex';
  
  // Atualizar estoque e salvar venda
  carrinho.forEach(item => {
    const produto = db.produtos.find(p => p.id === item.produto_id);
    if (produto) {
      produto.quantidade -= item.quantidade;
    }
  });
  
  db.config.ultimoIdVenda++;
  
  db.vendas.push({
    id: db.config.ultimoIdVenda,
    data: new Date().toISOString(),
    cliente_id: clienteSelecionado ? clienteSelecionado.id : null,
    itens: carrinho.map(item => ({
      produto_id: item.produto_id,
      descricao: item.descricao,
      quantidade: item.quantidade,
      preco_custo: item.preco_custo,
      preco_venda: item.preco_venda,
      fornecedor: item.fornecedor
    })),
    total: total,
    forma_pagamento: formaPagamento,
    usuario_id: parseInt(sessionStorage.getItem('user_id'))
  });
  
  salvarDados(db);
  
  // Limpar carrinho ap√≥s salvar
  setTimeout(() => {
    limparCarrinho();
  }, 1000);
});

document.getElementById('btn-fechar-cupom').addEventListener('click', () => {
  document.getElementById('modal-cupom').style.display = 'none';
});

document.getElementById('btn-imprimir-cupom').addEventListener('click', () => {
  const cupomContent = document.getElementById('cupom-container').innerHTML;
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>Cupom Fiscal</title>
      <style>
        body { font-family: 'Courier New', monospace; margin: 20px; }
        @media print {
          body { margin: 0; }
        }
      </style>
    </head>
    <body onload="window.print(); window.close()">
      ${cupomContent}
    </body>
    </html>
  `);
  printWindow.document.close();
});

// ========== FECHAR MODAIS COM CLIQUE FORA ==========
window.addEventListener('click', (e) => {
  if (e.target.classList.contains('modal')) {
    e.target.style.display = 'none';
  }
});

// Fun√ß√£o auxiliar para fechar modal
function fecharModal(id) {
  document.getElementById(id).style.display = 'none';
}

// ========== INICIALIZA√á√ÉO ==========
inicializarDados();

if (sessionStorage.getItem('user_id')) {
  document.getElementById('user-name').textContent = sessionStorage.getItem('user_nome');
  document.getElementById('screen-login').style.display = 'none';
  document.getElementById('screen-vendas').style.display = 'block';
  
  // Mostrar bot√£o de estoque s√≥ para admin
  if (sessionStorage.getItem('user_perfil') === 'admin') {
    document.getElementById('btn-estoque').style.display = 'block';
  }
  
  carregarProdutos();
  carregarClientes();
}

document.getElementById('barcode-input').focus();
</script>
</body>
</html>
