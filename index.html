<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõí Sistema de Vendas Completo</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        :root { --primary: #3498db; --success: #2ecc71; --danger: #e74c3c; --warning: #f39c12; --dark: #2c3e50; --light: #ecf0f1; --backup: #9b59b6; --barcode: #9b59b6; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: #f5f7fa; color: #333; height: 100vh; overflow: hidden; }
        
        /* Layout */
        .header { background: var(--dark); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        .container { display: flex; height: calc(100vh - 70px); }
        .sidebar { width: 350px; background: white; border-right: 1px solid #ddd; padding: 20px; overflow-y: auto; }
        .cart { flex: 1; display: flex; flex-direction: column; background: #f8f9fa; padding: 20px; }

        /* Elementos Interativos */
        .search-box input { width: 100%; padding: 14px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 15px; }
        .product-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; }
        .product-item:hover { background: #e3f2fd; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; flex: 1; }
        .btn-danger { background: var(--danger); color: white; }
        
        /* Scanner UI */
        #scanner-modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 9999; justify-content: center; align-items: center; 
            flex-direction: column; pointer-events: none; 
        }
        #scanner-modal.active { display: flex; pointer-events: all; }
        #reader { width: 100%; max-width: 400px; background: white; border-radius: 15px; overflow: hidden; }
        
        /* Notifica√ß√µes */
        .notification { position: fixed; top: 20px; right: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 10000; border-left: 5px solid var(--success); }
        
        .cart-items { background: white; border-radius: 10px; flex: 1; overflow-y: auto; padding: 10px; }
        .cart-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
        .total-row.final { font-size: 24px; font-weight: bold; color: var(--primary); margin-top: 15px; border-top: 2px solid #eee; padding-top: 10px; }
    </style>
</head>
<body>

<div id="screen-login" style="height:100vh; background: #2c3e50; display:flex; align-items:center; justify-content:center;">
    <div style="background: white; padding: 40px; border-radius: 15px; width: 350px; text-align: center;">
        <h2>üõí PDV Armarinho</h2><br>
        <input type="text" id="login-user" placeholder="Usu√°rio" style="width:100%; padding:10px; margin-bottom:10px;">
        <input type="password" id="login-pass" placeholder="Senha" style="width:100%; padding:10px; margin-bottom:20px;">
        <button class="btn btn-primary" id="btn-login" style="width:100%">Entrar</button>
        <p style="font-size: 12px; margin-top: 10px; color: #666;">admin / java1814</p>
    </div>
</div>

<div id="screen-vendas" style="display:none;">
    <div class="header">
        <div class="logo">üõí Armarinho - <span id="user-name">...</span></div>
        <button class="btn btn-danger" id="btn-logout">Sair</button>
    </div>
    <div class="container">
        <div class="sidebar">
            <button class="btn btn-primary" onclick="abrirScanner()" style="width: 100%; margin-bottom: 15px; background: var(--barcode);">üì∑ Abrir C√¢mera</button>
            <div class="search-box">
                <input type="text" id="barcode-input" placeholder="C√≥digo de barras ou Nome..." autocomplete="off">
            </div>
            <div id="lista-produtos"></div>
        </div>
        <div class="cart">
            <div class="cart-items" id="itens-carrinho"></div>
            <div class="total-row final">Total: <span id="total">R$ 0,00</span></div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-danger" onclick="cancelarVenda()">Cancelar</button>
                <button class="btn btn-primary" onclick="finalizarVenda()">Finalizar Venda</button>
            </div>
        </div>
    </div>
</div>

<div id="scanner-modal">
    <div id="reader"></div>
    <button class="btn btn-danger" onclick="fecharScanner()" style="margin-top: 20px;">‚ùå Fechar C√¢mera</button>
</div>

<div id="notification-container"></div>

<script>
let db = null;
let carrinho = [];
let html5QrcodeScanner = null;

// Inicializa√ß√£o de Dados
function init() {
    const saved = localStorage.getItem('vendas_db');
    if (saved) {
        db = JSON.parse(saved);
    } else {
        db = {
            usuarios: [{ login: 'admin', senha: 'java1814', nome: 'Admin' }],
            produtos: [
                { id: 1, codigo_barra: '7891234567890', descricao: 'Bot√£o de Madeira', preco_venda: 5.0 },
                { id: 2, codigo_barra: '7891234567891', descricao: 'Linha de Algod√£o', preco_venda: 8.5 },
                { id: 3, codigo_barra: '7891234567892', descricao: 'Agulha de Costura', preco_venda: 3.2 }
            ]
        };
        localStorage.setItem('vendas_db', JSON.stringify(db));
    }
}

// Notifica√ß√µes
function notify(msg, type = 'success') {
    const container = document.getElementById('notification-container');
    const n = document.createElement('div');
    n.className = 'notification';
    n.textContent = msg;
    container.appendChild(n);
    setTimeout(() => n.remove(), 3000);
}

// Login
document.getElementById('btn-login').onclick = () => {
    const u = document.getElementById('login-user').value;
    const s = document.getElementById('login-pass').value;
    const user = db.usuarios.find(x => x.login === u && x.senha === s);
    if (user) {
        sessionStorage.setItem('logado', 'true');
        document.getElementById('screen-login').style.display = 'none';
        document.getElementById('screen-vendas').style.display = 'block';
        document.getElementById('user-name').textContent = user.nome;
        renderProdutos();
    } else {
        alert('Dados incorretos!');
    }
};

document.getElementById('btn-logout').onclick = () => {
    sessionStorage.clear();
    location.reload();
};

// Vendas
function renderProdutos() {
    const lista = document.getElementById('lista-produtos');
    lista.innerHTML = db.produtos.map(p => `
        <div class="product-item" onclick="addCarrinho(${p.id})">
            <div>${p.descricao}</div>
            <div style="color:var(--primary); font-weight:bold;">R$ ${p.preco_venda.toFixed(2)}</div>
        </div>
    `).join('');
}

function addCarrinho(id) {
    const p = db.produtos.find(x => x.id === id);
    const item = carrinho.find(x => x.id === id);
    if (item) item.qtd++;
    else carrinho.push({ ...p, qtd: 1 });
    updateCart();
}

function updateCart() {
    const container = document.getElementById('itens-carrinho');
    let total = 0;
    container.innerHTML = carrinho.map(i => {
        total += i.preco_venda * i.qtd;
        return `<div class="cart-item"><span>${i.descricao} (${i.qtd}x)</span> <b>R$ ${(i.preco_venda * i.qtd).toFixed(2)}</b></div>`;
    }).join('');
    document.getElementById('total').textContent = `R$ ${total.toFixed(2)}`;
}

function finalizarVenda() {
    if (carrinho.length === 0) return alert("Carrinho vazio!");
    notify("Venda finalizada com sucesso!");
    carrinho = [];
    updateCart();
}

function cancelarVenda() {
    if (confirm("Deseja cancelar a venda?")) {
        carrinho = [];
        updateCart();
    }
}

// Evento do input de busca (Enter)
document.getElementById('barcode-input').onkeypress = (e) => {
    if (e.key === 'Enter') {
        const val = e.target.value;
        const p = db.produtos.find(x => x.codigo_barra === val || x.descricao.toLowerCase().includes(val.toLowerCase()));
        if (p) {
            addCarrinho(p.id);
            e.target.value = '';
        } else {
            notify("Produto n√£o encontrado", "danger");
        }
    }
};

// Scanner Logic
function abrirScanner() {
    const modal = document.getElementById('scanner-modal');
    modal.classList.add('active');
    
    html5QrcodeScanner = new Html5Qrcode("reader");
    html5QrcodeScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (text) => {
            const p = db.produtos.find(x => x.codigo_barra === text);
            if (p) {
                addCarrinho(p.id);
                notify("Adicionado: " + p.descricao);
                fecharScanner();
            }
        }
    ).catch(err => {
        alert("Erro ao abrir c√¢mera. Verifique as permiss√µes.");
        fecharScanner();
    });
}

function fecharScanner() {
    const modal = document.getElementById('scanner-modal');
    if (html5QrcodeScanner) {
        html5QrcodeScanner.stop().finally(() => {
            modal.classList.remove('active');
            html5QrcodeScanner = null;
        });
    } else {
        modal.classList.remove('active');
    }
}

init();
</script>
</body>
</html>
